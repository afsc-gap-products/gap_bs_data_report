---
output:
  officedown::rdocx_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

## vars

```{r vars}
a <- report_spp1[which(report_spp1$file_name == comb[jj]), ]

spp_sci <- text_list(unique(a$species_name))
spp_code <- a$species_code0[1]
if(grepl(pattern = "c(", x = spp_code, fixed = TRUE)) {spp_code <- a$species_code}
spp_print <- a$print_name[1]

spp_file <- a$file_name[1]
spp_taxon <- a$taxon[1]

# report_title == "community"
spp_plot_sizecomp <- a$plot_sizecomp[1]
spp_plot_idw <- a$plot_idw[1]
spp_plot_pa <- FALSE
spp_table_cpue <- FALSE
spp_text <- TRUE

if (report_title == "data") {
  spp_plot_idw <- a$plot_idw[1]
  spp_plot_pa <- FALSE # a$plot_pa[1]
  spp_table_cpue <- a$table_cpue[1]
  spp_text <- a$text_spp[1]
}

spp_bin <- eval(expr = parse(text = a$dist_bin))
```

## fig-[spp]-0-pres

```{r fig-spp, eval = (report_title == "ptpres")}
header <- spp_file
nickname <- paste0("fig-", jj, "-", spp_file, "-0-ptpres")
height <- width <- 5

figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, spp_file, ".png")) )

res <- knitr::knit_child(text = knitr::knit_expand( file = paste0(dir_code, "_child_save_figtab.Rmd")), quiet = TRUE)
```

## fig-dist-[taxon]-[spp]

```{r fig-dist-[taxon]-[spp], eval = (spp_plot_idw | spp_plot_pa)}
width <- full_page_portrait_width # 6.5  
case_yr0 <- 1
nickname <- paste0("fig-dist-", spp_file)
place_labels <- FALSE
viridis_palette_option <- "mako"
if (report_title == "data") {
  yrs <- unique(c(maxyr, nbsyr)) # c(compareyr, maxyr)
  # height <- ifelse(SRVY == "NEBS", 5.5, 4.25) 
  height <- full_page_portrait_height - 1
  row0 <- 2
  nickname <- paste0(nickname, "-data")
} else if (report_title == "community") {
  yrs <- unique(c(maxyr, nbsyr))
  height <- full_page_portrait_height-1
  row0 <- 2
  nickname <- paste0(nickname, "-comm")
} else if (report_title == "ptpres") {
  nickname <- paste0("fig-", jj, "-", spp_file, "-3-distribution-pres")
  yrs <- sort(unique(cpue$year), decreasing = TRUE)[1:8]
  height <- 6
  width <- 8
  row0 <- 2
} else if (report_title == "nbspres") {
  nickname <- paste0("fig-", jj, "-", spp_file, "-1-distribution-nbspres")
  yrs <- nbsyr[nbsyr != 2022]
  height <- 3
  width <- 8
  row0 <- 1
} 
yrs0 <- sort(yrs, decreasing = TRUE)
key.title <- paste0(stringr::str_to_sentence(spp_print),
                    ifelse(report_title == "ptpres", " ", '\n'), 
                    'Weight CPUE (kg/km²)')

# Select data ------------------------------------------------------------------
if (length(spp_code) > 1) {
  table_raw <- cpue %>%
    dplyr::filter(group %in% spp_print)
} else {
  table_raw <- cpue %>%
    dplyr::filter(species_code %in% spp_code)
}

table_raw <- table_raw %>% 
  dplyr::mutate(cpue_kgkm2 = ifelse(is.na(cpue_kgkm2), 0, cpue_kgkm2), 
                HAUL = NA) %>%
  dplyr::filter(
    SRVY %in% SRVY1 &
      year %in% yrs) %>% 
  dplyr::arrange(desc(year)) %>%
  dplyr::select(survey_definition_id, 
                SRVY,
                LATITUDE = latitude_dd_start,
                LONGITUDE = longitude_dd_start,
                CPUE_KGHA = cpue_kgkm2, 
                YEAR = year) %>% 
  dplyr::mutate(COMMON_NAME = spp_print) %>% 
  dplyr::ungroup() %>% 
  data.frame()

# is one of the areas zero-filled that for this subset, doesn't need to be?
# needs to be clean here so the downstream code picks the right map.area extent
temp <- table_raw %>% 
  dplyr::group_by(SRVY) %>% 
  dplyr::summarise(maxcpue = max(CPUE_KGHA, na.rm = TRUE))
if (0 %in% temp$maxcpue) {
  table_raw <- table_raw %>% 
    dplyr::filter(!(SRVY %in% temp$SRVY[temp$maxcpue == 0]))
}

# Find set.breaks --------------------------------------------------------------
if (!(NA %in% spp_bin)) {
  set.breaks <- c(0, spp_bin, max(table_raw$CPUE_KGHA))
} else {
  set.breaks <- akgfmaps::eval_plot_breaks(CPUE = table_raw$CPUE_KGHA, n.breaks = 5)
  set.breaks <- as.vector(unlist(set.breaks[set.breaks$style == "pretty", -1]))
}

# find appropriate map.area0 ---------------------------------------------------
# only if both species are only found in prt of the region, chnge the extrp.box
map.area0 <- map.area
reg_dat0 <- reg_dat
if (length(unique(table_raw$SRVY))==1 & SRVY == "NEBS") { # is this species in only 1 of the 2 survey areas (when SRVY == NEBS)?
  map.area0 <- ifelse(unique(table_raw$SRVY) == "EBS", "ebs", "nbs")
  reg_dat0 <- report_types[[unique(table_raw$SRVY)]]$reg_dat
  if (report_title != "ptpres") {
    height <- ifelse(reg_dat0$survey.area$SURVEY == "EBS_SHELF" & 
                       report_title == "data", height, height-1)
  }
}

# Write header for figure ------------------------------------------------------
header <- paste0("Distribution (Weight CPUE (kg/km^2^)) of ", 
                  spp_print, 
                  ifelse(is.na(spp_sci), "", 
                         paste0(" (",spp_sci,")")), 
                  " from the ",
                  range_text(yrs), " ", 
                  SURVEY, 
                  " shelf bottom trawl survey", 
                  ifelse(length(unique(table_raw$SRVY))>1, "s", ""), ". ", 
                  ifelse(length(unique(table_raw$SRVY)) > 1 & SRVY == "NEBS", 
                         "", 
                         paste0("This species was not encountered in the ", 
                                range_text(yrs), " ",
                                haul_cruises_maxyr$SRVY_long[haul_cruises_maxyr$SRVY !=
                                                               unique(table_raw$SRVY)], 
                                " shelf bottom trawl survey", ifelse(length(yrs)>1, "s", ""), 
                                ". ")))

# find which years need to be prepared with which region # crude, but here we are
a <- table_raw %>%
  dplyr::select(YEAR, survey_definition_id) %>%
  dplyr::distinct()  %>%
  dplyr::mutate(survey_definition_id = dplyr::case_when(
    survey_definition_id == 98 ~ "EBS",
    survey_definition_id == 143 ~ "NBS")) %>%
  tidyr::pivot_wider(id_cols = YEAR,
                     names_from = survey_definition_id,
                     values_from = survey_definition_id)
if (ncol(a)<3) {
  a$case <- unlist(a[,2])
} else {
  a <- a %>% 
    dplyr::mutate(
      case = dplyr::case_when(
        !is.na(EBS) & !is.na(NBS) ~ "both", 
        !is.na(EBS) ~ "EBS", 
        !is.na(NBS) ~ "NBS"
      ))
}

# dummy empty data
temp <- table_raw %>% 
  dplyr::filter(YEAR == 2022) %>% 
  dplyr::mutate(cpue_kgkm2 = NA, 
                cpue_nokm2 = NA, 
                hauljoin = NA)

if (map.area0 == "bs.all") {
  if ("NBS" %in% a$case) {
    for (i in which(a$case %in% "NBS")){
      table_raw <- table_raw %>% 
        dplyr::bind_rows(temp %>% 
                           dplyr::filter(SRVY == "EBS") %>% 
                           dplyr::mutate(YEAR = a$year[i]))
    }}
  
  if ("EBS" %in% a$case) {
    for (i in which(a$case %in% "EBS")){
      table_raw <- table_raw %>% 
        dplyr::bind_rows(temp %>% 
                           dplyr::filter(SRVY == "NBS") %>% 
                           dplyr::mutate(YEAR = a$year[i]))
    }}
}

# Create shapefile of species IDW ----------------------------------------------
idw <- make_idw_stack(
  x = table_raw,
  region = map.area0, 
  grouping.vars = "YEAR", 
  set.breaks = set.breaks,
  out.crs = out.crs, 
  extrapolation.grid.type = "sf")

# Plot -------------------------------------------------------------------------
for (case_yr in case_yr0) {
  if (length(case_yr0)>1) {
    if (case_yr == 1) {
      yrs <- yrs0[1:(length(yrs0)/2)]
    } else if (case_yr == 2) {
      yrs <- yrs0[((length(yrs0)/2)+1):length(yrs0)]
    }
  }
  
  figure <- ggplot() +
    ggplot2::geom_sf(data = reg_dat0$akland,
                     color = NA,
                     fill = "grey50")  +
    ggplot2::geom_sf(data = reg_dat0$graticule,
                     color = "grey80",
                     alpha = 0.2) +
    ggplot2::scale_y_continuous(name = "", #"Latitude",
                                limits = reg_dat0$plot.boundary$y,
                                breaks = reg_dat0$lat.breaks) +
    ggplot2::scale_x_continuous(name = "", #"Longitude",
                                limits = reg_dat0$plot.boundary$x,
                                breaks = reg_dat0$lon.breaks) +
    # geom_stars(data = stars0,
    #            na.rm = FALSE,
    #            show.legend = TRUE) +
    # Note here that the output already includes the survey region. You could filter this to exclude a region without data and it wouldn't affect estimation, etc because IDW is deterministic.
    
    geom_sf(data = idw$extrapolation.stack,
            mapping = aes(fill = var1.pred),
            na.rm = FALSE,
            show.legend = TRUE, 
            color = NA) +
    ggplot2::facet_wrap( ~ YEAR, nrow = row0) + 
    coord_sf() + 
    ggplot2::scale_fill_manual(
    name = stringr::str_to_title(key.title),
    values =  c("gray90",
                viridis::viridis(
                  option = viridis_palette_option,
                  direction = -1,
                  n = length(set.breaks)-1,
                  begin = 0.20,
                  end = 0.80)),
    na.translate = FALSE, # Don't use NA
    drop = FALSE) + 
    ggplot2::geom_sf(
      data = reg_dat$survey.area, 
      mapping = aes(color = SURVEY, 
                    geometry = geometry), 
      fill = "transparent", 
      linewidth = ifelse(row0 > 2, 1.5, 1), 
      show.legend = FALSE) +
    ggplot2::scale_color_manual(
      name = " ", 
      values = reg_dat$survey.area$color,
      breaks = reg_dat$survey.area$SURVEY,
      labels = reg_dat$survey.area$SRVY) + 
    ggplot2::guides(
      fill = guide_legend(
        order = 1,
        title.position = "top",
        label.position = "bottom",
        title.hjust = 0.5,
        override.aes = list(color = NA),
        nrow = 1),
      color = "none")  +
    ggplot2::theme( 
      panel.background = element_rect(fill = "white", 
                                      colour = NA), 
      panel.border = element_rect(fill = NA, 
                                  colour = "grey20"), 
      axis.text = element_text(size = ifelse(length(yrs)>4 & row0 == 1, 6, 8)),
      
      strip.background = element_blank(), 
      strip.text = element_text(size = 10, 
                                face = "bold"), 
      legend.text = element_text(size = 9),
      legend.background = element_rect(colour = "transparent", 
                                       fill = "transparent"),
      legend.key = element_rect(colour = "transparent", 
                                fill = "transparent"),
      legend.position = "bottom", 
      legend.box = "horizontal",
      legend.box.spacing = unit(0, "pt"),  # reduce space between legend & plot
      legend.margin=margin(0, 0, 0, 0)) 
  
  if (report_title == "ptpres") {
    figure <- figure +
      ggplot2::theme(legend.title=element_blank() ) +
      ggplot2::ggtitle(key.title) 
  }
  
  if (report_title %in% c("nbspres")) {
    
    figure <- figure + 
      ggplot2::geom_sf_text(
        data = data.frame(y = 64.500126, x = -165.408402) %>% 
          sf::st_as_sf(coords=c("x","y"), crs="+proj=longlat") %>% 
          sf::st_transform(crs = "EPSG:3338") %>%
          dplyr::mutate(label = "Nome"), 
        mapping = aes(label = label), 
        fontface = "italic", 
        size = 4) +
      geom_text(data = subset(reg_dat$place.labels, 
                              type == "mainland"), 
                aes(x = x, y = y, label = lab), 
                size = 7, group = 99) + 
      geom_shadowtext(data = subset(reg_dat$place.labels, 
                                    type == "peninsula"), 
                      aes(x = x, y = y, label = lab), size = 3, angle = 3, 
                      bg.color = "white", color = "black", group = 99) + 
      geom_shadowtext(
        data = subset(reg_dat$place.labels, 
                      type %in% c("bathymetry", "islands")),
        aes(x = x, y = y, label = lab), 
        bg.color = "white", color = "black", 
        size = 2, group = 99)
  }  
  
  if (report_title %in% c("community")) {
    figure <-
      cowplot::ggdraw(figure +
                        ggplot2::theme( plot.margin = margin(1.8, 0, 0, 0, "cm") ) ) +
      cowplot::draw_image(image = readPNG(paste0(dir_img, spp_file, ".png")),
                          x = .77, y = .42, # top right
                          # x = 0.09, y = -.35, # lower left
                          hjust = 0, vjust = 0,
                          width = .18)
  }
  
  res <- knitr::knit_child(text = knitr::knit_expand( file = paste0(dir_code, "_child_save_figtab.Rmd")), quiet = TRUE)
}
```

## fig-sizecomp-[taxon]-[spp]

```{r fig-sizecomp-[taxon]-[spp], eval = spp_plot_sizecomp}
width <- full_page_portrait_width # 6.5  
nickname <- paste0("fig-sizecomp-", spp_file)
header <- ""
legend_font_size <- 12
if (report_title == "data") {
  yrs <- unique(c(maxyr, nbsyr)) # c(compareyr, maxyr)
  height <- full_page_portrait_height # ifelse(SRVY == "NEBS", full_page_portrait_height-1, 3.25) 
  print_n <- FALSE
  srvy <- SRVY1
  nickname <- paste0(nickname, "-data")
  legend_font_size <- 10
} else if (report_title == "community") {
  yrs <- unique(c(maxyr, nbsyr))
  height <- full_page_portrait_height
  print_n <- TRUE
  srvy <-"NBS"
  nickname <- paste0(nickname, "-comm")
  legend_font_size <- 12
} else if (report_title == "ptpres") {
  yrs <- unique(sizecomp$year)
  print_n <- FALSE
  height <- 6
  width <- 7
  srvy <- SRVY1 # "NBS"
  nickname <- paste0("fig-", jj, "-", spp_file, "-4-sizecomp-pres")
  legend_font_size <- 12
} else if (report_title == "nbspres") {
  yrs <- c(maxyr, compareyr)
  print_n <- FALSE
  height <- 2
  width <- 3
  srvy <- "NBS"
  nickname <- paste0("fig-", jj, "-", spp_file, "-3-sizecomp-nbspres")
  legend_font_size <- 12
}

lengths0 <- lengths %>%
  dplyr::filter(species_code %in% spp_code &
                  SRVY %in% srvy &
                  year %in% yrs)

type <- unique(lengths0$sentancefrag)

if (length(spp_code) > 1) {
  table_raw <- sizecomp %>%
    dplyr::filter(group %in% spp_print)
} else {
  table_raw <- sizecomp %>%
    dplyr::filter(species_code %in% spp_code)
}

table_raw <- table_raw  %>%
  dplyr::filter(SRVY %in% srvy &
                  year %in% yrs) %>% 
  dplyr::mutate(sex = str_to_sentence(sex), 
                sex = factor(sex, 
                             levels = c("Unsexed", "Males", "Females", "Immature females", "Mature females"), 
                             labels = c("Unsexed", "Males", "Females", "Immature females", "Mature females"),
                             ordered = TRUE), 
                SRVY_long = dplyr::case_when(
                  SRVY == "EBS" ~ "eastern Bering Sea", 
                  SRVY == "NBS" ~ "northern Bering Sea") ) %>% 
  dplyr::arrange(sex) 

if (!(nrow(table_raw) == 0)) {
  
  if (report_title %in% c("community", "data")) {
    if (report_title == "community") {
      
      header <- paste0("Total population estimates at length for ",
                       spp_print, ifelse(is.na(spp_sci), "", 
                                         paste0(" (",spp_sci,")")), 
                       " calculated from ",
                       range_text(yrs)," ",
                       text_list(paste0(unique(table_raw$SRVY_long))), 
                       " shelf bottom trawl survey", 
                       ifelse(length(unique(table_raw$SRVY))==1 & length(unique(table_raw$year))==1, "", "s"),
                       ". ",
                       ifelse(print_n, 
                              "Total number of individuals measured during the survey is indicated in the upper right corner of each plot.", ""))
      
    } else if (report_title == "data") {
      
      if (SRVY == "NEBS" & length(unique(table_raw$SRVY))>1) {
        table_raw <- dplyr::bind_rows(
          table_raw, 
          table_raw %>%
            dplyr::filter(species_code %in% spp_code &
                            SRVY %in% SRVY &
                            year %in% yrs) %>% 
            dplyr::group_by(year, taxon, species_code, sex, population_count) %>% 
            dplyr::summarise(length_mm) %>% 
            dplyr::mutate(
              SRVY = factor(x = SRVY, levels = c("EBS", "NBS", "EBS and NBS"), ordered = TRUE), 
              SRVY = "EBS and NBS", 
              SRVY_long = paste0("combined ", SURVEY)))
      }
      
      header <- paste0("Total abundance-at-length estimates of ",
                       spp_print, ifelse(is.na(spp_sci), "", 
                                         paste0(" (",spp_sci,")")), 
                       " by sex (",text_list(tolower(unique(table_raw$sex))),
                       ") in ",
                       ifelse(!grepl(pattern = " crab", x = spp_print, ignore.case = TRUE), 
                              "centimeters (cm)", "millimeters (mm)"),
                       " encountered during the ",
                       range_text(yrs)," ",
                       text_list(paste0(unique(table_raw$SRVY_long))), 
                       " shelf bottom trawl survey", 
                       ifelse(length(unique(table_raw$SRVY))==1 & length(unique(table_raw$year))==1, "", "s"),
                       ". ",
                       ifelse(length(setdiff(SRVY1, unique(table_raw$SRVY)))>0,
                              paste0("There were no lengths collected for this species in the ", 
                                     range_text(yrs), " ",
                                     haul_cruises_maxyr$SRVY_long[haul_cruises_maxyr$SRVY != unique(table_raw$SRVY)],
                                     " shelf trawl survey",ifelse(length(yrs)>1, "s", ""),". "), 
                              ""),
                       
                       "Length distributions scaled up to the total estimated population size. ", 
                       ifelse(print_n, 
                              "Total number of individuals measured during the survey is indicated in the upper right corner of each plot.", ""))
    }
    
    figure <- plot_sizecomp(
      sizecomp0 = table_raw %>% 
        dplyr::mutate(
          # SRVY0 = SRVY, 
          #             SRVY = SRVY_long, 
          SRVY_long = gsub(replacement = "", x = SRVY_long, pattern = SURVEY), 
          SRVY_long = stringr::str_to_title(SRVY_long)),
      lengths0 = lengths0,
      spp_code = spp_code,
      spp_print = stringr::str_to_title(spp_print),
      type = type,
      print_n = print_n, 
      ridgeline = FALSE)
  } else if (report_title %in% c("ptpres", "nbspres")) {
    if ("EBS" %in% table_raw$SRVY) {
      figure1 <- figure <- plot_sizecomp(
        sizecomp0 = table_raw %>% 
          dplyr::filter(SRVY == "EBS") %>% 
          dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long)),
        lengths0 = lengths0,
        spp_code = spp_code,
        spp_print = stringr::str_to_sentence(spp_print),
        type = type,
        print_n = print_n, 
        ridgeline = TRUE)
    }
    if ("NBS" %in% table_raw$SRVY) {
      figure2 <- figure <- plot_sizecomp(
        sizecomp0 = table_raw %>% 
          dplyr::filter(SRVY == "NBS") %>% 
          dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long)),
        lengths0 = lengths0,
        spp_code = spp_code,
        spp_print = stringr::str_to_sentence(spp_print),
        type = type,
        print_n = print_n, 
        ridgeline = FALSE)
    }
    if (sum(unique(table_raw$SRVY) %in% c("NBS", "EBS")) == 2) {
      figure <- cowplot::plot_grid(figure1, figure2)
    }
  }
  
  figure <- figure +
    ggplot2::theme(strip.text = element_text(size = legend_font_size, face = "bold"))
  
  if (report_title %in% c("community")) { 
    figure <-
      cowplot::ggdraw(figure + 
                        ggplot2::theme( plot.margin = margin(1.2, 0, 0, 0, "cm") ) ) +
      cowplot::draw_image(image = readPNG(paste0(dir_img, spp_file, ".png")),
                          x = .78, y = .44, # top right
                          # x = 0.07, y = -.42, # lower left
                          hjust = 0, vjust = 0,
                          width = .18)
  }
  
} else {
  header <- ""
  figure <- ggplot(data = data.frame(x = 1, y = 1, label = "There are no data for this year and species"), mapping = aes(y=y, x=x)) +
    geom_text(mapping = aes(label = label))
}

res <- knitr::knit_child(text = knitr::knit_expand( file = paste0(dir_code, "_child_save_figtab.Rmd")), quiet = TRUE)
```

## tab-stats-[spp] pres

```{r tab-stats-[spp], eval = c(report_title %in% c("community", "data"))}
nickname <- paste0("tab-stats-", spp_file)
### Stats table ----------------------------------------------------------------
haul0 <- catch_haul_cruises %>% 
  dplyr::select("station", "stratum", "latitude_dd_start", "longitude_dd_start", 
                "depth_m", "bottom_temperature_c" ,"surface_temperature_c", 
                "survey_name", "SRVY", "year", "species_code", 
                "weight_kg", "count", "hauljoin")

temp_stat <- dplyr::left_join(
  x = haul0 %>% 
    dplyr::filter(year == maxyr) %>% 
    dplyr::select(station, SRVY) %>% 
    dplyr::distinct() %>% 
    dplyr::select(SRVY) %>% 
    table() %>% 
    data.frame() %>% 
    dplyr::rename(tot = Freq), 
  y = haul0 %>% 
    dplyr::filter(species_code %in% spp_code & year == maxyr) %>% 
    dplyr::select(station, SRVY) %>% 
    dplyr::distinct() %>% 
    dplyr::select(SRVY) %>% 
    table() %>% 
    data.frame() %>% 
    dplyr::rename(spp = Freq), 
  by = "SRVY") %>% 
  dplyr::mutate(str = paste0(spp, " of ", tot, 
                             "\n(", formatC(spp/tot*100, digits = 1, format = "f", big.mark = ","), "%)")) %>% 
  dplyr::filter(!is.na(spp))

### Env table ------------------------------------------------------------------

temp_env <- haul0 %>% 
  dplyr::filter(SRVY %in% SRVY1 & 
                  year == maxyr & 
                  species_code %in% spp_code) %>% 
  dplyr::select(SRVY, 
                # "Latitude (°N)" = latitude_dd_start, 
                # "Longitude (°W)" = longitude_dd_start, 
                "Bottom\nDepth (m)" = depth_m, 
                "Bottom Temperature (°C)" = bottom_temperature_c, 
                "Surface Temperature (°C)" = surface_temperature_c) %>% 
  dplyr::group_by(SRVY) %>% 
  dplyr::summarise(across(where(is.numeric), .fns = 
                            list(Min = min,
                                 Max = max))) %>%
  tidyr::pivot_longer(is.numeric,
                      names_sep='_',
                      names_to=c('variable', '.value')) %>%
  dplyr::mutate(across(dplyr::ends_with("C)"), 
                       formatC, big.mark = ",", digits = 1, format = "f"), 
                val = ifelse(Min == Max, Min, paste0(Min, " — ", Max))) %>%
  dplyr::mutate(across(dplyr::ends_with("m)"), 
                       formatC, big.mark = ",", digits = 0, format = "f"), 
                val = ifelse(Min == Max, Min, paste0(Min, " — ", Max))) %>%
  dplyr::relocate(variable, dplyr::ends_with(SRVY1[1])) %>% 
  dplyr::select(-Min, -Max) %>% 
  tidyr::pivot_wider(id_cols = "SRVY",
                     names_from = "variable",
                     values_from = "val")
# tidyr::pivot_wider(id_cols = "variable",
#                    names_from = "SRVY",
#                    values_from = c("val"))

### Biomass table --------------------------------------------------------------

yrs <- c(maxyr, compareyr)

temp_bio <- dplyr::left_join(
  x = total_biomass %>% 
    dplyr::group_by(SRVY, year) %>% 
    dplyr::summarise(total = sum(total, na.rm = TRUE)), 
  y = biomass %>% 
    dplyr::filter(year %in% yrs & 
                    species_code %in% spp_code &
                    stratum %in% 999) %>%
    dplyr::select(SRVY, year, biomass_mt, population_count, 
                  cpue_kgkm2_mean, cpue_nokm2_mean) %>% 
    dplyr::filter((biomass_mt !=0)), 
  by = c("year", "SRVY")) %>% 
  dplyr::filter(year %in% yrs) %>% 
  dplyr::group_by(SRVY, year, total) %>% 
  dplyr::summarise(biomass_mt = sum(biomass_mt, na.rm = TRUE),  
                   population_count = sum(population_count, na.rm = TRUE),  
                   cpue_kgkm2_mean = sum(cpue_kgkm2_mean, na.rm = TRUE),  
                   cpue_nokm2_mean = sum(cpue_nokm2_mean, na.rm = TRUE)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(print_name = spp_print)

if (sum(is.na(temp_bio$print_name[temp_bio$SRVY == "NBS"])) == 
    nrow(temp_bio[temp_bio$SRVY == "NBS",])) {
  temp_bio <- temp_bio %>% 
    dplyr::filter(SRVY != "NBS")
}

if (sum(is.na(temp_bio$print_name[temp_bio$SRVY == "EBS"])) == 
    nrow(temp_bio[temp_bio$SRVY == "EBS",])) {
  temp_bio <- temp_bio %>% 
    dplyr::filter(SRVY != "EBS")
}

temp_bio1 <- data.frame()
for (i in 1:nrow(temp_bio)) {
  
  compareyr0 <- ifelse(temp_bio$year[i] == min(yrs), min(yrs), max(yrs[yrs < temp_bio$year[i]]))
  srvy0 <- temp_bio$SRVY[i]
  temp_bio0 <- ifelse(temp_bio$year[i] == min(yrs), NA, 
                      temp_bio$biomass_mt[temp_bio$SRVY == srvy0 & temp_bio$year == compareyr0])
  
  temp_bio1  <- dplyr::bind_rows(
    temp_bio1, 
    c(
      SRVY = temp_bio$SRVY[i], 
      year = temp_bio$year[i], 
      "Population" = ifelse(is.na(temp_bio$population_count[i]), 
                            "-", 
                            xunits(temp_bio$population_count[i])), 
      "Biomass\n(t)" = ifelse(is.na(temp_bio$biomass_mt[i]), 
                              "-", 
                              paste0(xunits(temp_bio$biomass_mt[i], 
                                            val_under_x_words = NULL))), 
      "Biomass\n% Total" = dplyr::case_when(
        is.na(temp_bio$biomass_mt[i]) ~ "-", 
        paste0(formatC(x = (temp_bio$biomass_mt[i]/temp_bio$total[i])*100, 
                       digits = 1, format = "f", big.mark = ","), "%") == "0.0%" ~ "<0.01%", 
        TRUE ~ paste0(formatC(x = (temp_bio$biomass_mt[i]/temp_bio$total[i])*100, 
                              digits = 1, format = "f", big.mark = ","), "%") ), 
      "Biomass\n% Change" = dplyr::case_when(
        temp_bio$year[i] == min(yrs) ~ "-",
        is.na(temp_bio$biomass_mt[i]) ~ "-", #paste0("none caught in ", temp_bio$year[i]), 
        is.na(temp_bio0) ~ "-", #paste0("none caught in ", compareyr0), 
        abs(pchange(start = temp_bio$biomass_mt[i], end = temp_bio0, value_only = TRUE)) < 1 ~ "no change",
        TRUE ~ sub(replacement = "", pattern = "an ", 
                   x = gsub(pattern = "a ", replacement = "", 
                            x = paste0(pchange(end = temp_bio$biomass_mt[i], 
                                               start = temp_bio0), "\nfrom ", compareyr0)) ) ))
  )
}

### Combine temp tables --------------------------------------------------------

table_raw <- temp_stat %>% 
  dplyr::select(SRVY, "Stations\nPresent" = str) %>% 
  dplyr::left_join(temp_env) %>% 
  dplyr::left_join(temp_bio1 %>% 
                     dplyr::filter(year == maxyr) %>% 
                     dplyr::select(-year)) %>% 
  dplyr::left_join(data.frame(SRVY = SRVY1, 
                              SRVY_long = stringr::str_to_title(SRVY11), 
                              Survey = gsub(" .*$", "", stringr::str_to_title(SRVY11)))) %>% 
  dplyr::select(-SRVY) %>% 
  dplyr::relocate(Survey) %>% 
  dplyr::arrange(Survey) %>% 
  dplyr::rename("Bering Sea\nSurvey" = Survey)

if (sum(table_raw$`Biomass\n% of Total` == "0.0%") == nrow(table_raw)) {
  table_raw <- table_raw %>% 
    dplyr::select(-`Biomass\n% of Total`)
}

### print table ----------------------------------------------------------------

header <- paste0("Summary of catch location environmental variables, as well as biomass and population estimates for ", 
                 spp_print, " (", spp_sci, ") in the ", 
                 ifelse(length(table_raw$`Bering Sea\nSurvey`) == 1, paste0(tolower(table_raw$`Bering Sea\nSurvey`), " Bering Sea"), SURVEY), 
                 " survey area", 
                 ifelse(length(table_raw$`Bering Sea\nSurvey`) == 1, "s", plural_surveys),". ")

table_raw0 <- table_raw %>% 
  dplyr::select(-SRVY_long)
table_print0 <- data.frame("var" = rownames(t(table_raw0))[-1], 
                           data.frame(t(table_raw0)[-1,]))  
names(table_print0) <- c("var", stringr::str_to_title(table_raw$SRVY_long))
rownames(table_print0) <- NULL
table_print0[,1] <- gsub(x = table_print0[,1], pattern = "\n", replacement = " ")
table_print0[,2] <- gsub(x = table_print0[,2], pattern = "\n", replacement = " ")
if (ncol(table_print0) > 2) {
  table_print0[,3] <- gsub(x = table_print0[,3], pattern = "\n", replacement = " ")
}
table_print <- table_print0 %>% 
  flextable::flextable()  %>% 
  theme_flextable_nmfstm(row_lines = FALSE, 
                             pgwidth = full_page_portrait_width)  %>%
  flextable::bold(j = 1, part = "body") %>% 
  flextable::theme_zebra() %>% 
  flextable::vline(border = fp_border(color="grey70")) %>% 
  flextable::set_header_labels("var" = "")   %>%
  # theme_flextable_nmfstm(row_lines = FALSE,
  #                        pgwidth = full_page_portrait_width) %>%
  flextable::width(width = 2.25) %>%
  flextable::width(j = 1, width = 2) %>%
  flextable::bg(
    i = ~ (grepl(x = table_print0[,names(table_print0)[2]], pattern = "increase")), 
    bg = positive, 
    j = names(table_print0)[2]) %>% 
  flextable::bg(
    i = ~ (grepl(x = table_print0[,names(table_print0)[2]], pattern = "decrease")), 
    bg = negative, 
    j = names(table_print0)[2]) %>% 
  flextable::bg(
    i = ~ (grepl(x = table_print0[,names(table_print0)[2]], pattern = "no change")), 
    bg = neutral, 
    j = names(table_print0)[2]) 

if (ncol(table_print0) > 2) {
  table_print <- table_print %>% 
    flextable::bg(
      i = ~ (grepl(x = table_print0[,names(table_print0)[3]], pattern = "increase")), 
      bg = positive, 
      j = names(table_print0)[3]) %>% 
    flextable::bg(
      i = ~ (grepl(x = table_print0[,names(table_print0)[3]], pattern = "decrease")), 
      bg = negative, 
      j = names(table_print0)[3]) %>% 
    flextable::bg(
      i = ~ (grepl(x = table_print0[,names(table_print0)[3]], pattern = "no change")), 
      bg = neutral, 
      j = names(table_print0)[3]) 
}

res <- knitr::knit_child(text = knitr::knit_expand( file = paste0(dir_code, "_child_save_figtab.Rmd")), quiet = TRUE)
```

## tab-est-[taxon]-[spp]-[wt or num]

```{r tab-est-[taxon]-[spp]-[wt or num], eval = ((report_title == "data") & spp_table_cpue)}
nickname0 <- paste0("tab-est-", spp_file, "-") 

if (length(spp_code) > 1) {
  table_raw <- biomass %>%
    dplyr::filter(group %in% spp_print)
} else {
  table_raw <- biomass %>%
    dplyr::filter(species_code %in% spp_code)
}

temp <- table_raw %>% 
  dplyr::filter(year == maxyr &
                  stratum %in% strat0) %>% 
  dplyr::select(SRVY, stratum, cpue_kgkm2_mean, cpue_kgkm2_sd, 
                biomass_mt, biomass_sd, biomass_dw, biomass_up, 
                cpue_nokm2_mean, cpue_nokm2_sd, 
                population_count, population_sd, population_dw, population_up, 
                n_weight, n_count, n_length)  %>% 
  dplyr::right_join(y = biomass %>% 
                      dplyr::filter(year == maxyr &
                                      stratum %in% strat0) %>% 
                      dplyr::select(SRVY, stratum) %>%
                      dplyr::distinct()) %>% 
  dplyr::left_join(y = data.frame(SRVY = SRVY1, 
                                  SRVY_long = stringr::str_to_title(SRVY11))) %>%
  dplyr::mutate(stratum = as.character(stratum)) %>%
  dplyr::arrange(stratum) %>% 
  dplyr::arrange(SRVY) %>% 
  dplyr::mutate(stratum = ifelse(stratum == 999, "Total", stratum))

if (sum(is.na(temp$cpue_kgkm2_mean[temp$SRVY == "NBS"])) == 
    nrow(temp[temp$SRVY == "NBS",])) {
  temp <- temp %>% 
    dplyr::filter(SRVY != "NBS")
}

if (sum(is.na(temp$cpue_kgkm2_mean[temp$SRVY == "EBS"])) == 
    nrow(temp[temp$SRVY == "EBS",])) {
  temp <- temp %>% 
    dplyr::filter(SRVY != "EBS")
}

# Were lengths taken for this taxon? If not, we wont include the n_length column in the table and optomize for space
# include_n_length <- !(sum(temp$n_length[temp$stratum == "Total"] %in% 0) == 
#                         length(temp$n_length[temp$stratum == "Total"]))
include_n_length <- FALSE

if (sum(temp$biomass_mt[temp$stratum == "Total"] != 0, na.rm = TRUE) > 0) {
  
  if (sum(temp$biomass_mt [temp$stratum == "Total"] %in% 0, na.rm = TRUE)>0) {
    
    temp <- temp %>% 
      dplyr::filter(SRVY == temp$SRVY[temp$stratum == "Total" & 
                                        temp$biomass_mt  != 0])
  }
  
  haul_cruises_maxyr0 <- haul_cruises_maxyr %>% 
    dplyr::filter(SRVY %in% unique(temp$SRVY))
  
  for (i in 1:2) {
    table_raw <- data.frame()
    
    if (i == 1) { # CPUE (WT/km²) and BIOMASS
      nickname <- paste0(nickname0, "wt")
      
      table_raw <- temp %>% 
        dplyr::select(SRVY, SRVY_long, stratum, 
                      cpue_kgkm2_mean, cpue_kgkm2_sd, 
                      biomass_mt, biomass_sd, biomass_dw, biomass_up, 
                      n_weight) 
      
      # if (!include_n_length) {
      #   table_raw <- table_raw %>% 
      #     dplyr::select(-n_length)
      # }
      
      if (nrow(table_raw) != 0) { # if none were caught, don't do any of this
        
        cpue_kgkm2_mean0<-find_units(unit = "kg/km²", unt = "kg/km²", dat = table_raw$cpue_kgkm2_mean[table_raw$cpue_kgkm2_mean != 0])    
        cpue_kgkm2_sd0 <- find_units(unit = "", unt = "", table_raw$cpue_kgkm2_sd[table_raw$cpue_kgkm2_sd != 0])
        biomass_mt0 <- find_units(unit = "t", unt = "t", table_raw$biomass_mt [table_raw$biomass_mt  != 0])
        biomass_sd0 <- find_units(unit = "", unt = "", table_raw$biomass_sd[table_raw$biomass_sd != 0])
        
        header <- paste0("Mean weight CPUE",cpue_kgkm2_mean0$unit_word,
                         " ", cpue_kgkm2_sd0$unit_wrd,
                         ", and estimated biomass",biomass_mt0$unit_word,
                         " with standard deviation (SD;",gsub("[()]", "", biomass_sd0$unit_word), 
                         ", and 95% lower (LCL;", gsub("[()]", "", biomass_mt0$unit_word),
                         ") and upper (UCL;", gsub("[()]", "", biomass_mt0$unit_word),
                         ") confidence limits for ")
        
        table_print0 <- table_raw %>% 
          dplyr::mutate(cpue_kgkm2_mean = formatC(x = cpue_kgkm2_mean/cpue_kgkm2_mean0$divby, 
                                                  digits = 2, 
                                                  format = "f", big.mark = ","),
                        cpue_kgkm2_sd = formatC(x = cpue_kgkm2_sd/cpue_kgkm2_sd0$divby, 
                                                digits = 2, 
                                                format = "f", big.mark = ","), 
                        biomass_mt = formatC(x = biomass_mt/biomass_mt0$divby, 
                                             digits = ifelse(biomass_mt0$divby>1, 2, 0), 
                                             format = "f", big.mark = ",") , 
                        biomass_up = formatC(x = biomass_up/biomass_mt0$divby,
                                             digits = ifelse(biomass_mt0$divby>1, 2, 0),
                                             format = "f", big.mark = ",") ,
                        biomass_dw = formatC(x = biomass_dw/biomass_mt0$divby,
                                             digits = ifelse(biomass_mt0$divby>1, 2, 0),
                                             format = "f", big.mark = ",") ,
                        biomass_sd = formatC(x = biomass_sd/biomass_sd0$divby, 
                                             digits = ifelse(biomass_sd0$divby>1, 2, 0), 
                                             format = "f", big.mark = ","))
        table_print0[is.na(table_print0)] <- 0
        table_print0[table_print0 == " NA"] <- "-"
        table_print0[table_print0 == "NA"] <- "-"
        table_print0$n_weight[table_print0$n_weight == 0] <- "-"
        
        table_print <- table_print0 %>% 
          dplyr::select(-SRVY) %>% 
          flextable::as_grouped_data(groups = c("SRVY_long"), columns = NULL)  %>%
          flextable::as_flextable(hide_grouplabel = TRUE) %>%
          flextable::set_header_labels(
            cpue_kgkm2_mean = paste0("CPUE Mean ", ifelse(cpue_kgkm2_mean0$unit_wrd=="", "", paste0(" ",cpue_kgkm2_mean0$unit_wrd))), 
            cpue_kgkm2_sd = paste0("CPUE\nSD ", ifelse(cpue_kgkm2_sd0$unit_wrd=="", "", paste0("\n",cpue_kgkm2_sd0$unit_wrd))), 
            biomass_mt = paste0("Biomass", ifelse(biomass_mt0$unit_wrd=="", "", paste0("\n",biomass_mt0$unit_wrd))), 
            biomass_sd = paste0("Biomass\nSD ", ifelse(biomass_sd0$unit_wrd=="", "", paste0(" ",biomass_sd0$unit_wrd))), 
            biomass_dw = paste0("95% LCL", ifelse(biomass_mt0$unit_wrd=="", "", paste0("\n",biomass_mt0$unit_wrd))),
            biomass_up = paste0("95% UCL", ifelse(biomass_mt0$unit_wrd=="", "", paste0("\n",biomass_mt0$unit_wrd))),
            n_weight = "# Hauls w/weights"
          ) 
      }
    } else { # CPUE No/km² and population_count
      
      nickname <- paste0(nickname0, "num")
      
      table_raw <- temp %>% 
        dplyr::select(SRVY_long, SRVY, stratum, 
                      cpue_nokm2_mean, cpue_nokm2_sd, population_dw, population_up, 
                      population_count, population_sd, n_count, n_length)
      
      if (!include_n_length) {
        table_raw <- table_raw %>% 
          dplyr::select(-n_length)
      }
      
      if (nrow(table_raw) != 0) { # if none were caught, don't do any of this
        
        cpue_nokm2_mean0 <- find_units(unit = "no/km²", unt = "no/km²", dat = table_raw$cpue_nokm2_mean[table_raw$cpue_nokm2_mean != 0])
        cpue_nokm2_sd0 <- find_units(unit = "", unt = "", table_raw$cpue_nokm2_sd[table_raw$cpue_nokm2_sd != 0])
        population_count0 <- find_units(unit = "", unt = "", table_raw$population_count[table_raw$population_count != 0])
        population_sd0 <- find_units(unit = "", unt = "", table_raw$population_sd[table_raw$population_sd != 0])
        
        header <- paste0("Mean Number CPUE", cpue_nokm2_mean0$unit_word,
                         " with standard deviation", cpue_nokm2_sd0$unit_word,
                         ", and estimated population", population_count0$unit_word,
                         " with standard deviation", population_sd0$unit_word, 
                         " and 95% lower (LCL;", gsub("[()]", "", population_count0$unit_word),
                         ") and upper (UCL;", gsub("[()]", "", population_count0$unit_word),
                         ") confidence limits for ")
        
        table_print0 <- table_raw %>% 
          dplyr::mutate(cpue_nokm2_mean = formatC(x = cpue_nokm2_mean/cpue_nokm2_mean0$divby, 
                                                  digits = 2, 
                                                  format = "f", big.mark = ","),
                        cpue_nokm2_sd = formatC(x = cpue_nokm2_sd/cpue_nokm2_sd0$divby, 
                                                digits = 2, 
                                                format = "f", big.mark = ","), 
                        population_count = formatC(x = population_count/population_count0$divby, 
                                                   digits = ifelse(population_count0$divby>1, 2, 0), 
                                                   format = "f", big.mark = ",") , 
                        population_up = formatC(x = population_up/population_count0$divby,
                                                digits = ifelse(population_count0$divby>1, 2, 0),
                                                format = "f", big.mark = ",") ,
                        population_dw = formatC(x = population_dw/population_count0$divby,
                                                digits = ifelse(population_count0$divby>1, 2, 0),
                                                format = "f", big.mark = ",") ,
                        population_sd = formatC(x = population_sd/population_sd0$divby, 
                                                digits = ifelse(population_sd0$divby>1, 2, 0), 
                                                format = "f", big.mark = ","))
        table_print0[is.na(table_print0)] <- 0
        table_print0[table_print0 == " NA"] <- "-"
        table_print0[table_print0 == "NA"] <- "-"
        table_print0$n_count[table_print0$n_count == 0] <- "-"
        
        table_print <- table_print0 %>% 
          dplyr::select(-SRVY) %>%
          flextable::as_grouped_data(groups = c("SRVY_long"), columns = NULL)  %>%
          flextable::as_flextable(hide_grouplabel = TRUE) %>%
          flextable::set_header_labels(
            cpue_nokm2_mean = paste0("CPUE Mean", ifelse(cpue_nokm2_mean0$unit_wrd=="", "", paste0(" ", cpue_nokm2_mean0$unit_wrd))), 
            cpue_nokm2_sd = paste0("CPUE\nSD ", ifelse(cpue_nokm2_sd0$unit_wrd=="", "", paste0("\n", cpue_nokm2_sd0$unit_wrd))), 
            population_count = paste0("Population", 
                                      ifelse(population_count0$unit_wrd=="", "", paste0("\n", population_count0$unit_wrd))),
            population_sd = paste0("Population\nSD ", ifelse(population_sd0$unit_wrd=="", "", paste0(" ", population_sd0$unit_wrd))), 
            population_dw = paste0("95% LCL", ifelse(population_count0$unit_wrd=="", "", paste0("\n", population_count0$unit_wrd))),
            population_up = paste0("95% UCL", ifelse(population_count0$unit_wrd=="", "", paste0("\n", population_count0$unit_wrd))),
            n_count = "# Hauls w/counts"
          ) 
      }
    }
    
    header <- paste0(header,
                     spp_print, 
                     ifelse(is.na(spp_sci), "", paste0(" (", spp_sci, ")")), 
                     " by stratum encountered during the ",
                     maxyr," ", SURVEY, 
                     " shelf bottom trawl survey",plural_surveys,". ", 
                     ifelse(length(setdiff(SRVY1, unique(table_raw$SRVY)))>0, 
                            paste0("This species was not encountered in the ", 
                                   maxyr, " ",
                                   haul_cruises_maxyr$SRVY_long[haul_cruises_maxyr$SRVY != unique(table_raw$SRVY)],
                                   " shelf trawl survey. "), 
                            ""))#,
    # ifelse(!include_n_length, "No lengths were collected for this taxon. ", ""))
    
    table_print <- table_print %>% 
      flextable::bold(i = ~ (stratum == "Total") ) %>%
      flextable::valign(valign = "top") %>% 
      flextable::set_header_labels(stratum = "Stratum")  %>%
      theme_flextable_nmfstm(row_lines = FALSE, 
                             pgwidth = full_page_portrait_width)  %>%
      flextable::width(width = ((full_page_portrait_width-.2-.9)/(ncol(table_print0)-1)), unit = "in") %>% # need to not account for the SRVY_long column
      flextable::width(j = 1, width = .2, unit = "in") %>%
      flextable::width(j = 2, width = .9, unit = "in") %>%
      # flextable::width(j = (ncol(table_print0)-1), width = .9, unit = "in") %>%
      # flextable::width(width = ((full_page_portrait_width-.4)/(ncol(table_print0)-1)), unit = "in") %>%
      # flextable::width(width = .4, unit = "in", j = c("stratum")) %>%
      flextable::align(align = "right", part = "all") %>%
      flextable::align(align = "center", part = "body", j = "stratum") %>% 
      flextable::merge_v(j = 1:2, part = "header")
    
    if (include_n_length) { # if lengths were collected, include the column
      table_print <- table_print %>%
        flextable::set_header_labels(
          n_length = "# Hauls w/lengths") %>% 
        flextable::width(width = .5, unit = "in", j = "n_length") 
    }
    
    if (length(unique(table_raw$SRVY)) > 1) {
      table_print <- table_print %>% 
        flextable::align(j = 1, i = ~ !is.na(SRVY_long), align = "left") %>%
        flextable::bold(j = 1, i = ~ !is.na(SRVY_long) ) %>%
        flextable::padding(j = 1, i = ~ is.na(SRVY_long),
                           padding.left = 7) %>% 
        flextable::hline(x = .,i = ~ (stratum == "Total"), part = "body")
    }
    
    res <- knitr::knit_child(text = knitr::knit_expand( file = paste0(dir_code, "_child_save_figtab.Rmd")), quiet = TRUE)
  }
}
```

## fig-biopop-timeseries-[spp]

```{r, fig-biopop-timeseries-[spp], eval = (report_title == "data")}
pcol <- viridis::mako(n = 2, begin = .2, end = .6, direction = -1)

if (length(spp_code) > 1) {
  table_raw <- biomass %>%
    dplyr::filter(group %in% spp_print)
} else {
  table_raw <- biomass %>%
    dplyr::filter(species_code %in% spp_code)
}

table_raw <- table_raw %>%
  dplyr::filter(stratum == 999) %>% 
  dplyr::left_join(y = haul_cruises %>% 
                     dplyr::select(SRVY, SRVY_long) %>% 
                     dplyr::distinct(),
                   by = "SRVY") %>%
  dplyr::mutate(print_name = spp_print, 
                SRVY_long = stringr::str_to_title(SRVY_long) ) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(SRVY_long, year, 
                biomass_mt, population_count, 
                biomass_up, population_up, 
                biomass_dw, population_dw) %>% 
  tidyr::pivot_longer(cols = c(biomass_mt, population_count, 
                               biomass_up, population_up, 
                               biomass_dw, population_dw), 
                      names_to = "var", 
                      values_to = "val") %>% 
  dplyr::mutate(
    y_long = dplyr::case_when(
        grepl(x = var, pattern = "biomass") ~ "Biomass", 
        grepl(x = var, pattern = "population") ~ "Population"
   ), coll = dplyr::case_when(
    var == "biomass_mt" ~ "val", 
    var == "population_count" ~ "val", 
    var == "biomass_up" ~ "ci_up", 
    var == "population_up" ~ "ci_up", 
    var == "biomass_dw" ~ "ci_dw", 
    var == "population_dw" ~ "ci_dw"
  )) %>% 
  tidyr::pivot_wider(id_cols = c(SRVY_long, year, y_long), 
                     names_from = coll, values_from = val, 
                     id_expand = TRUE) %>% 
  dplyr::ungroup() 

  # find missing years in timeseries and re-enter them so plot breaks for missing years
  yr_missing <- data.frame()
  for (i in 1:length(unique(table_raw$SRVY_long))){
    temp <- table_raw[table_raw$SRVY_long %in% unique(table_raw$SRVY_long)[i], ]
    
    yr_missing <- tidyr::crossing(year = setdiff((min(temp$year):max(temp$year)),
                                      unique(temp$year)),
                                  y_long = unique(table_raw$y_long), 
                 SRVY_long = unique(table_raw$SRVY_long)[i]) 
  }

  a_bio <- find_units(unit = "t", 
                  unt = "t", 
                  dat = table_raw$val[table_raw$y_long == "Biomass"]) 
  
  a_pop <- find_units(unit = "", 
                  unt = "", 
                  dat = table_raw$val[table_raw$y_long == "Population"]) 

  table_raw <- table_raw %>% 
    dplyr::bind_rows(yr_missing) %>% 
    dplyr::mutate(
      species_name = spp_print, 
                common_name = spp_print, 
                print_name = spp_print, 
                taxon = spp_taxon, 
                col = dplyr::case_when(
      SRVY_long == "Eastern Bering Sea" ~ pcol[1],
      SRVY_long == "Northern Bering Sea" ~ pcol[2]), 
      var_ = dplyr::case_when(
        y_long == "Biomass" ~ 
          paste0("Biomass", ifelse(a_bio$unit_word == "", "", "\n"), a_bio$unit_word), 
        y_long == "Population" ~ 
          paste0("Population", ifelse(a_pop$unit_word == "", "", "\n"), a_pop$unit_word)        
      ), 
      divby = dplyr::case_when(
        y_long == "Biomass" ~ a_bio$divby, 
        y_long == "Population" ~ a_pop$divby        
      ),
      unit_wrd = dplyr::case_when(
        y_long == "Biomass" ~ a_bio$unit_wrd, 
        y_long == "Population" ~ a_pop$unit_wrd        
      ),
      unit_word = dplyr::case_when(
        y_long == "Biomass" ~ a_bio$unit_word, 
        y_long == "Population" ~ a_pop$unit_word        
      ),
      y = val/divby, 
      y_ci_dw = ci_dw/divby, 
      y_ci_up = ci_up/divby  ) %>% 
    dplyr::arrange(desc(year))
  

  # find mean for mean line
  table_raw_mean <- table_raw %>% 
    dplyr::group_by(SRVY_long, y_long, var_) %>% 
    dplyr::summarise(y_mean = mean(y, na.rm = TRUE)) %>% 
    dplyr::left_join(
      biomass %>%
  dplyr::filter(stratum == 999 &
                  year >= 1987) %>% 
  dplyr::group_by(survey_definition_id) %>% 
    dplyr::summarise(minyr = min(year, na.rm = TRUE), 
                     maxyr = max(year, na.rm = TRUE)) %>% 
  dplyr::left_join(y = haul_cruises %>% 
                     dplyr::select(survey_definition_id, SRVY_long) %>% 
                     dplyr::distinct()) %>% 
  dplyr::select(-survey_definition_id) %>% 
    dplyr::mutate(SRVY_long = stringr::str_to_title(SRVY_long)))
  
  anno<-NA
  temp<-setdiff(x = unique(table_raw$SRVY), 
                y = unique(table_raw_mean$SRVY))
  if (length(temp) != 0) {
    anno <- paste0("Data for this species in the\n", 
                   temp, 
                   " is too limited to plot.")
    
    col_anno <- table_raw$col[which(unique(table_raw$SRVY)==temp)]
    col <- table_raw$col[which(unique(table_raw$SRVY)!=temp)]
  }
  
  # add mean data to table_raw
  # table_raw <-
  #   dplyr::left_join(
  #     x = table_raw,
  #     y = table_raw_mean)
  
if (report_title %in% "community") {
  nickname <- paste0("fig-biomass-", spp_file, "-comm")
  height <- 3
  width <- full_page_portrait_width
  legend_font_size <- 10
  table_raw <- table_raw %>% dplyr::filter(y_long == "Biomass")
} else if (report_title %in% c("ptpres")) {
  nickname <- paste0("fig-", jj, "-", spp_file, "-1-biomass-pres")
  height <- 4
  legend_font_size <- 8
  table_raw <- table_raw %>% dplyr::filter(y_long == "Biomass")
} else if (report_title %in% "data") {
  nickname <- paste0("fig-biopop-timeseries-", spp_file)
  height <- 4
  width <- full_page_portrait_width
  legend_font_size <- 10
}
  
  figure <-
    # general plotting aesthetics
    ggplot2::ggplot(data = table_raw, 
           mapping = aes(x = year, 
                         y = y, 
                         color = SRVY_long, 
                         group = SRVY_long)) +
    # plot mean line 
    ggplot2::geom_segment(
        data = table_raw_mean,
        mapping = aes(x = minyr, 
                      xend = maxyr, 
                      y = y_mean, 
                      yend = y_mean),
        alpha = .5,
        linetype = "dashed", 
        linewidth = 2)  +
    # plot points and lines
    ggplot2::geom_line(size = 1) +
    ggplot2::geom_point(size = 1.5, aes(shape = SRVY_long)) + 
    # axis aesthetics 
    # ggplot2::ggtitle(spp_print) +  # No title
    ggplot2::scale_x_continuous(
      name = "Year", 
      # limits = range(yrs_plotted, na.rm = TRUE), 
      labels = scales::label_number(accuracy = 1, big.mark = ""))  +
    ggplot2::scale_y_continuous(
      name = "", # spp_print,
      labels = scales::comma) +
    # survey area color aesthetics
    ggplot2::scale_color_manual(values = unique(table_raw$col)) +
    # plot error bars
    ggplot2::geom_errorbar(mapping = aes(ymin = y_ci_dw, ymax = y_ci_up), 
                           width = .2,
                    alpha = 0.5) + 
    # Set y axis minimum to always be 0 & remove resulting "y" label
    ylim(0, NA) +
    ylab(" ") +
    # facet grid
    ggplot2::facet_grid(rows = vars(var_), 
                        scales = "free", 
                        switch = "both") +
    # aesthetics
    # Create & position legend title
    ggplot2::labs(color = stringr::str_to_title(spp_print)) +  # force title case
    ggplot2::labs(shape = stringr::str_to_title(spp_print)) +
    ggplot2::guides(color = guide_legend(title.position = "top",
                                         title.hjust = 0.5,
                                         title.vjust = -0.5),
                    shape = guide_legend(title.position = "top",
                                         title.hjust = 0.5,
                                         title.vjust = -0.5)) +
    ggplot2::theme( 
      strip.placement = "outside",
      strip.background = element_blank(), 
      strip.text = element_text(size = 10, face = "bold"), 
      panel.background = element_rect(fill = "white"),
      panel.grid.major.y = element_blank(),
      panel.grid.minor.y = element_blank(),
      panel.grid.minor.x = element_blank(),
      panel.grid.major.x = element_line(colour = "grey95"),
      panel.border = element_rect(fill = NA, colour = "grey20"),
      # legend.title = element_blank(), # We do want a legend title!
      legend.text = element_text(size = legend_font_size),
      legend.background = element_rect(colour = "transparent", 
                                       fill = "transparent"),
      legend.key = element_rect(colour = "transparent",
                                fill = "transparent"),
      axis.title = element_text(size = legend_font_size, face = "bold"),
      axis.text = element_text(size = legend_font_size),
      legend.position = "bottom", 
      legend.box = "horizontal",
      legend.box.spacing = unit(0, "pt"),
      legend.margin=margin(0, 0, 0, 0))
  
  if (!is.na(anno)) {
    figure <- figure +
      ggplot2::geom_text(x = Inf, 
                         y = -Inf, 
                         hjust = 1.2, 
                         vjust = -.3, 
                         label = anno, 
                         show.legend = FALSE, 
                         size = 4, 
                         fontface = "italic",
                         color = col_anno)
  }

  temp <- table_raw %>% 
    dplyr::select(y_long, unit_word, unit_wrd) %>% 
    unique() %>% 
    dplyr::mutate(str0 = paste0(
                 tolower(y_long),
                 paste0(ifelse(unit_wrd == "", "", unit_word))))
    
  header <- paste0("Time series of ", 
                         spp_print,
                 ifelse(is.na(spp_sci), "",
                        paste0(" (",spp_sci,")")), " ",
                 text_list(temp$str0), 
                 " from the ", min(table_raw$year, na.rm = TRUE),"-", 
                 max(table_raw$year, na.rm = TRUE), " ", 
                 # range_text(range(table_raw$year)), " ", 
                 ifelse(length(unique(table_raw$SRVY_long)) > 1, 
                        SURVEY, 
                        unique(table_raw$SRVY_long)), 
                 " shelf bottom trawl survey", 
                 ifelse(length(unique(table_raw$SRVY_long)) > 1, plural_surveys, ""),". ")
  
res <- knitr::knit_child(text = knitr::knit_expand( file = paste0(dir_code, "_child_save_figtab.Rmd")), quiet = TRUE)
```

