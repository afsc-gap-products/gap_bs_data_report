---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

```{r}
spp_sci <- report_spp$report_name_scientific[jj]
spp_code <- eval(expr = parse(text = report_spp$species_code[jj]))
spp_common<-report_spp$common_name[jj]
spp_file <- report_spp$file_name[jj]
```

### `r spp_common` (*`r spp_sci`*)

```{r}
# find basic info about species
haul_maxyr_spp<-catch_haul_cruises_maxyr %>% 
  dplyr::filter(species_code %in% spp_code)

haul_compareyr_spp<-catch_haul_cruises_compareyr %>% 
  dplyr::filter(species_code %in% spp_code)

# haul_maxyr_1_spp <- haul %>% 
#   dplyr::filter(species_code %in% spp_code &
#                   year %in% (maxyr-1))
```

```{r}
species_table <- function(haul_spp, spp_common, SURVEY, SRVY = NA) {
  
  # Edit This:
  header <- paste0("Summary of environmental variables that ", NMFSReports::tolower2(spp_common), " (", spp_sci, ") have been found in across the ", SURVEY, ifelse(SRVY %in% NA, paste0(" (", SRVY, ")"), ""))
  
  # Select data and make plot
  cols<-c("start_latitude", "start_longitude",  "weight", "number_fish", "bottom_depth", "gear_temperature", "surface_temperature")
  COLS<-c("Latitude", "Longitude", 
          "Weight", "Abundance", 
          "Bottom Depth", "Bottom Temperature", "Surface Temperature")
  
  # basiccontent0<-c()
  table_spp<-c()
  
  for (ii in 1:length(cols)) {
    table_spp<-rbind.data.frame(table_spp, 
                                data.frame(metric0 = cols[ii], 
                                           Metric = COLS[ii], 
                                           Min = min(haul_spp[cols[ii]], na.rm = T), 
                                           Max = max(haul_spp[cols[ii]], na.rm = T), 
                                           Mean = sum(haul_spp[cols[ii]], na.rm = T)/nrow(haul_spp)
                                ))
  }
  
  table_spp_print <- table_spp
  table_spp_print[, c("Min", "Max", "Mean")] <- 
    NMFSReports::mod_number(x = table_spp_print[, c("Min", "Max", "Mean")], 
                            comma_seperator = TRUE, 
                            divideby = 1, 
                            digits = 2)
  table_spp_print$metric0<-NULL
  
  table_raw = table_spp
  table_print = table_spp_print
  
  return(list("raw" = table_raw, 
              "print" = table_print))
}


species_text <- function(haul_maxyr, haul_compareyr_spp, table_spp_print, 
                         haul_maxyr_spp, length_maxyr, 
                         length_type, 
                         spp_common, spp_code, SRVY, maxyr, compareyr) {
  
  str <- c()
  
  # <!-- how many stations -->
  str <- paste0(str, 
                "Out of the total number of successful hauls (", 
                length(unique(haul_maxyr$hauljoin)), ") ",  
                NMFSReports::tolower2(spp_common), 
                " was found during ", 
                length(unique(haul_maxyr_spp$hauljoin)), 
                " hauls (", 
                formatC(x = (length(unique(haul_maxyr_spp$hauljoin))/length(unique(haul_maxyr$hauljoin)))*100, digits = 1, format = "f"), 
                "% of stations). ")
  
  str <- paste0(str, "

During the ", maxyr, 
" survey, ", 
NMFSReports::tolower2(spp_common), 
" were present at ", 
formatC(x = (length(unique(haul_maxyr_spp$hauljoin))/length(unique(haul_maxyr$hauljoin)))*100, digits = 1, format = "f") , 
"% of stations in the ", SRVY, " (", 
length(unique(haul_maxyr_spp$hauljoin)), " of ", 
length(unique(haul_maxyr$hauljoin)), 
" stations). ")
  
  # <!-- bottom tempature -->
  str <- paste0(str, "

", NMFSReports::tolower2(spp_common, capitalizefirst = TRUE), 
" were found in bottom temperatures as warm as ", 
as.numeric(table_spp_print %>% dplyr::filter(Metric == "Bottom Temperature") %>% dplyr::select(Max)) , 
"°C and as cold as ", 
as.numeric(table_spp_print %>% dplyr::filter(Metric == "Bottom Temperature") %>% dplyr::select(Min)) , 
"°C (Figure ", cnt_figures,"). ")
  
  # <!-- surface temperature -->
  str <- paste0(str, "

", NMFSReports::tolower2(spp_common, capitalizefirst = TRUE), 
" were found in areas where surface temperatures were as warm as ", 
as.numeric(table_spp_print %>% dplyr::filter(Metric == "Surface Temperature") %>% dplyr::select(Max)) , 
"°C and as cold as ", 
as.numeric(table_spp_print %>% dplyr::filter(Metric == "Surface Temperature") %>% dplyr::select(Min)) , 
"°C (Figure ", cnt_figures,"). ")
  
  # <!-- Depth -->
  str <- paste0(str, "

They were found in waters with depths between ", 
as.numeric(table_spp_print %>% dplyr::filter(Metric == "Bottom Depth") %>% dplyr::select(Min)) , 
" m and ", as.numeric(table_spp_print %>% dplyr::filter(Metric == "Bottom Depth") %>% dplyr::select(Max)) , " m. ")
  
  # <!-- Sizes caught  -->
  str <- paste0(str, "

The ", 
NMFSReports::text_list(length_type$sentancefrag[length_type$length_type_id %in% unique(length_maxyr$length_type)]), 
" of ", NMFSReports::tolower2(spp_common, capitalizefirst = TRUE), 
" measured during the survey were between ", min(length_maxyr$length, na.rm = TRUE), 
" and ", max(length_maxyr$length, na.rm = TRUE), " ", 
unique(dplyr::case_when(spp_code %in% 1:31550 ~ 'cm', 
                        spp_code %in% 68000:69930 ~ 'mm'), 
       TRUE ~ 'NO MEASUREMENT'), ". ")
  
  # <!-- weight -->
  str <- paste0(str, "

The total number of ", 
NMFSReports::tolower2(spp_common), 
" estimated to have been caught by the survey is ", 
NMFSReports::xunits(value = sum(haul_maxyr_spp$number_fish, na.rm = TRUE)), 
" individuals, which equates to ", 
NMFSReports::xunits(value = sum(haul_maxyr_spp$weight, na.rm = TRUE)), 
" kg of biomass. ")
  
  str <- paste0(str, "

Compared with ", compareyr, ", 
abundance experienced ", 
NMFSReports::pchange(start = sum(haul_compareyr_spp$number_fish, na.rm = TRUE), end = sum(haul_maxyr_spp$number_fish, na.rm = TRUE)) ,
" and there was ", 
NMFSReports::pchange(start = sum(haul_compareyr_spp$weight, na.rm = TRUE), end = sum(haul_maxyr_spp$weight, na.rm = TRUE)) , 
" in biomass. ")
  
  return(str)
  
}

```


`r  ifelse(SRVY %in% "NEBS", "## **EBS**", "") `

```{r}
SRVY000<-"EBS"
SURVEY000 = "eastern Bering Sea"

if (SRVY %in% "NEBS") {
  
  table_spp_maxyr <- species_table(haul_spp = haul_maxyr_spp, 
                             spp_common, 
                             SURVEY = SURVEY000, 
                             SRVY = SRVY000) 
  
  table_spp_compareyr <- species_table(haul_spp = haul_compareyr_spp, 
                             spp_common, 
                             SURVEY = SURVEY000, 
                             SRVY = SRVY000) 
  
  table_spp <- dplyr::full_join(
    x = table_spp_maxyr$print %>% 
      dplyr::rename(
        Min_maxyr = Min, 
             Max_maxyr = Max, 
             Mean_maxyr = Mean), 
    x = table_spp_compareyr$print %>% 
      dplyr::rename(
        Min_compareyr = Min, 
             Max_compareyr = Max, 
             Mean_compareyr = Mean), 
    by = "Metric")
  
  text_spp <- species_text(haul_maxyr, haul_compareyr_spp, table_spp_print = table_spp_maxyr$print, haul_maxyr_spp, length_maxyr, length_type, spp_common, spp_code, SRVY, maxyr, compareyr)
  
  print(
  "## **EBS**
        
  ", table_spp$print)

}
```


`r species_text(haul_maxyr, haul_compareyr_spp, table_spp_print = table_spp$table_print, haul_maxyr_spp, length_maxyr, length_type, spp_common, spp_code, SRVY, maxyr, compareyr) `

`r  ifelse(SRVY %in% "NEBS", "## **NBS**", "") `

  
`r ifelse(SRVY %in% "NEBS", species_text(haul_maxyr %>% dplyr::filter(SRVY %in% "NBS"), haul_compareyr_spp %>% dplyr::filter(year %in% (maxyr-1) & SRVY %in% "NBS"), table_spp_print_nbs, haul_maxyr_spp %>% dplyr::filter(SRVY %in% "NBS"), length_maxyr %>% dplyr::filter(SRVY %in% "NBS"), length_type, spp_common, spp_code, SRVY = "NBS", cnt_figures), "") `  

`r  ifelse(SRVY %in% "NEBS", "## **EBS**", "") `
  
```{r}

if (SRVY %in% "NEBS" && sum(haul_maxyr_spp$SRVY %in% "EBS")>0) {
  # print("NBS")
  table_list<-species_table(table_list, 
                            haul_maxyr_spp %>% dplyr::filter(SRVY %in% "EBS"), 
                            spp_common, SURVEY, SRVY = "EBS") 
    # table_spp_print_ebs <- table_list[[length(table_list)]]$print
    table_list[[length(table_list)]]$print  %>%
          format_cells(rows = 0, # make column names
                       cols = 1:ncol(table_list[[length(table_list)]]$print), # for all columns
                       fonttype = "bold") %>% # bold
          knitr::kable(row.names = FALSE, booktabs = TRUE) #print table in text
}
```


`r ifelse(SRVY %in% "NEBS", species_text(haul_maxyr %>% dplyr::filter(SRVY %in% "EBS"), haul_compareyr_spp %>% dplyr::filter(SRVY %in% "EBS"), table_spp_print_ebs, haul_maxyr_spp %>% dplyr::filter(SRVY %in% "EBS"), length_maxyr %>% dplyr::filter(SRVY %in% "EBS"), length_type, spp_common, spp_code, SRVY = "EBS", cnt_figures), "") `


```{r}
#text
insert <- readtext(file = paste0(dir_out_rawdata, "/doc_",spp_common,".docx"))
```

`r insert$text`

```{r}
# str <- c()
# # if NEBS, then write for NBS and EBS
# if (SRVY %in% "NEBS") {
#   
#   str <- paste0("**NBS**
#                 ", 
#                 species_text(haul_maxyr %>% dplyr::filter(SRVY %in% "NBS"), 
#                       haul_compareyr_spp %>% dplyr::filter(SRVY %in% "NBS"), 
#                       table_spp_print_nbs, 
#                       haul_maxyr_spp %>% dplyr::filter(SRVY %in% "NBS"), 
#                       length_maxyr %>% dplyr::filter(SRVY %in% "NBS"), 
#                       length_type, 
#                       spp_common, 
#                       spp_code, 
#                       SRVY = "NBS",
#                       cnt_figures), 
#          "**EBS**
#          ", 
#          species_text(haul_maxyr %>% dplyr::filter(SRVY %in% "EBS"), 
#                       haul_compareyr_spp %>% dplyr::filter(SRVY %in% "EBS"), 
#                       table_spp_print_ebs, 
#                       haul_maxyr_spp %>% dplyr::filter(SRVY %in% "EBS"), 
#                       length_maxyr %>% dplyr::filter(SRVY %in% "EBS"), 
#                       length_type, 
#                       spp_common, 
#                       spp_code, 
#                       SRVY = "EBS",
#                       cnt_figures)
#          )
#   print(str)
#   
# }



# <!-- <!-- how many stations --> -->
# <!-- <!-- Should I use haul or hauljoin? --> -->
# <!-- Out of the total number of successful hauls (`r length(unique(haul_maxyr$hauljoin))`) `r NMFSReports::tolower2(spp_common)` was found during `r length(unique(haul_maxyr_spp$hauljoin))` (`r formatC(x = (length(unique(haul_maxyr_spp$hauljoin))/length(unique(haul_maxyr$hauljoin)))*100, digits = 1, format = "f") `% of stations). -->
# 
# <!-- During the `r maxyr` survey, `r NMFSReports::tolower2(spp_common)` were present at `r formatC(x = (length(unique(haul_maxyr_spp$hauljoin))/length(unique(haul_maxyr$hauljoin)))*100, digits = 1, format = "f") `% of stations in the `r SRVY` (`r length(unique(haul_maxyr_spp$hauljoin))` of `r length(unique(haul_maxyr$hauljoin))` stations). -->
# 
# 
# <!-- <!-- bottom tempature --> -->
# <!-- `r NMFSReports::tolower2(spp_common, capitalizefirst = TRUE)` were found in bottom temperatures as warm as `r as.numeric(table_spp_print %>% dplyr::filter(Metric == "Surface Temperature") %>% dplyr::select(Max)) `°C and as cold as `r as.numeric(table_spp_print %>% dplyr::filter(Metric == "Surface Temperature") %>% dplyr::select(Min)) `°C (Figure 7). -->
# 
# <!-- <!-- surface temperature --> -->
# <!-- `r NMFSReports::tolower2(spp_common, capitalizefirst = TRUE)` were found in areas where surface temperatures were as warm as `r as.numeric(table_spp_print %>% dplyr::filter(Metric == "Bottom Temperature") %>% dplyr::select(Max)) `°C and as cold as `r as.numeric(table_spp_print %>% dplyr::filter(Metric == "Bottom Temperature") %>% dplyr::select(Min)) `°C (Figure 7). -->
# 
# <!-- <!-- Depth --> -->
# <!-- They were found in waters with depths between `r as.numeric(table_spp_print %>% dplyr::filter(Metric == "Bottom Depth") %>% dplyr::select(Min)) ` m and `r as.numeric(table_spp_print %>% dplyr::filter(Metric == "Bottom Depth") %>% dplyr::select(Max)) ` m.   -->
# 
# 
# <!-- <!-- Sizes caught were between  --> -->
# <!-- The `r NMFSReports::text_list(length_type$sentancefrag[length_type$length_type_id %in% unique(length_maxyr$length_type)])` of `r NMFSReports::tolower2(spp_common, capitalizefirst = TRUE)` measured during the survey were between `r min(length_maxyr$length)` and `r max(length_maxyr$length)` `r unique(dplyr::case_when(spp_code %in% 1:31550 ~ "cm", spp_code %in% 68000:69930 ~ "mm"), TRUE ~ "NO MEASUREMENT")`. -->
# 
# 
# <!-- <!-- weight --> -->
# <!-- The total number of `r NMFSReports::tolower2(spp_common)` estimated to have been caught by the survey is `r NMFSReports::xunits(value = sum(haul_maxyr_spp$number_fish, na.rm = TRUE))` individuals, which equates to `r NMFSReports::xunits(value = sum(haul_maxyr_spp$weight, na.rm = TRUE))` kg of biomass.  -->
# 
# <!-- Compared with `r maxyr-1`, abundance experienced `r NMFSReports::pchange(start = sum(haul_compareyr_spp$number_fish, na.rm = TRUE), end = sum(haul_maxyr_spp$number_fish, na.rm = TRUE)) ` and there was `r NMFSReports::pchange(start = sum(haul_compareyr_spp$weight, na.rm = TRUE), end = sum(haul_maxyr_spp$weight, na.rm = TRUE)) ` in biomass.  -->
```


```{r fig_cpue_spp_ }
nickname0 <- paste0("fig_cpue_", spp_common)
header <- paste0("CPUE of **", NMFSReports::tolower2(spp_common), "** (*", stringr::str_to_sentence(spp_sci), "*) across the ", SURVEY)
height = 12

cpue_spp <- cpue %>% 
  filter(species_code %in% spp_code & 
           year %in% maxyr)

# if (length(SRVY1) > 1 && SRVY %in% "NEBS") {
# 
#   dat_cpue_spp_n <- cpue_spp %>%
#     dplyr::filter(survey == "NBS")
# 
#   idwplot <- make_idw_map0(COMMON_NAME = dat_cpue_spp_n$species_name,
#                          LATITUDE = dat_cpue_spp_n$latitude,
#                          LONGITUDE = dat_cpue_spp_n$longitude,
#                          CPUE_KGHA = dat_cpue_spp_n$cpue_kgha,
#                          region = "bs.north",
#                          key.title = spp_common)
# 
#   plot0 <- idwplot$plot +
#     theme(legend.position = "left",
#     panel.background = element_rect(fill = "transparent"), # bg of the panel
#     plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
#     panel.grid.major = element_blank(), # get rid of major grid
#     panel.grid.minor = element_blank(), # get rid of minor grid
#     legend.background = element_rect(fill = "transparent"), # get rid of legend bg
#     legend.box.background = element_rect(fill = "transparent") # get rid of legend panel bg
#   )
# 
# }

idwplot <- akgfmaps::make_idw_map(COMMON_NAME = cpue_spp$species_name, 
                         LATITUDE = cpue_spp$latitude, 
                         LONGITUDE = cpue_spp$longitude, 
                         CPUE_KGHA = cpue_spp$cpue_kgha, 
                         region = map.area, 
                         key.title = spp_common)
idwplot <- idwplot %>% change_fill_color(new.scheme = "grey", show.plot = FALSE)

plot0 <- idwplot$plot + 
  theme(#legend.position = "right", 
        legend.text = element_text(size = 8), 
        legend.background = element_blank(),
        legend.title = element_text(size = 8), 
        plot.margin = unit(c(0,0,0,0), "cm")) + 
  geom_shadowtext(data = subset(placenames, type %in% c("bathymetry", "islands")),
    aes(x = x, y = y, label = lab), bg.color = "white", color = "black", size = 3, group = 99) + 
  geom_shadowtext(data = subset(placenames, type %in% c("convention line", "peninsula")),
    aes(x = x, y = y, label = lab, angle = 43), bg.color = "white", color = "black", size = 3, group = 99) + 
      geom_shadowtext(data = subset(placenames, type %in% c("mainland")),
      aes(x = x, y = y, label = lab), bg.color = "white", color = "black", size = 8, group = 99)  

if (!(map.area %in% c("nbs", "bs.north"))) {
  plot <- plot + 
      geom_shadowtext(data = subset(placenames, type %in% c("mainland")),
      aes(x = x, y = y, label = lab), bg.color = "white", color = "black", size = 8, group = 99)  
}


```



 ## fig_idw_bottemp_longterm_mean_ (above and below)

> need to figure out how to plot bs.all and bs.south on same stars_list facet_wrap

```{r fig_idw_bottemp_longterm_mean_}
nickname0 <- "fig_idw_bottemp_longterm_mean_"

for (i in 1:2) { # two cases, above and below
  width = 6
  height = 6
  usePNGPDF = "png"  
  
  subobj <- TRUE
  newobj <- ifelse(i==1, TRUE, FALSE)
  TF <- ifelse(i==1, FALSE, TRUE)
  case <- ifelse(i==1, "below", "above")
  
  header <- paste0("Contour maps of ",spp_common," (*",spp_sci,"*) the near-bottom temperatures from the ",
                   NMFSReports::text_list(sort(temps_wt_avg_yr_abovebelow_plots[,case])),
                   " Bering Sea shelf bottom trawl surveys, years when the survey mean bottom temperature was ",
                   case,
                   " the long-term stratum area-weighted mean.")
  footnote<- NA
  nickname <- paste0(nickname0, case)
  alttext <- paste0(header)
  
  table_raw <- haul %>%
      dplyr::filter(!is.na(gear_temperature)) %>% 
      dplyr::arrange(-year) 
  
  figure <- plot_idw_xbyx(
    yrs = temps_wt_avg_yr_abovebelow_plots[,case], 
    dat = table_raw,
    cruises = cruises, 
    lat = "start_latitude",
    lon = "start_longitude",
    var = "gear_temperature", 
    grid = "continuous.grid",
    extrap.box = extrap.box, 
    key.title = "Bottom Temperature (°C)", 
    workfaster = workfaster, 
    SRVY = SRVY)

  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_figures[length(list_figures)]$res <- res <- paste0("
###### 

",res,"

")
  
  assign(value = res, x = nickname)
}

```
