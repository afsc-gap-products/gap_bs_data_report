---
output:
  word_document:
    pandoc_args: ["--metadata-file=header.yaml"]
    reference_docx: styles_reference.docx
    df_print: kable
csl: "../cite/citestyle.csl"
bibliography: "../cite/bibliography.bib"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

### `r spp_common` (*`r spp_sci`*)

```{r}
# find basic info about species
haul_maxyr_spp<-haul_maxyr %>% 
  dplyr::filter(species_code %in% spp_code)

haul_maxyr_1_spp <- haul %>% 
  dplyr::filter(species_code %in% spp_code &
                  year %in% (maxyr-1))

# length_maxyr
# length_maxyr <- dat_length_maxyr %>% 
  # dplyr::filter(species_code %in% spp_code)

```

`r  ifelse(SRVY %in% "NEBS", "## **EBS**", "") `

```{r tab_species_table_}

# nickname0 <- "tab_species_table_"
nickname0 <- "tab_biomass_est_fish_"

# Select data and make plot
for (i in 1:nrow(haul_cruises_maxyr)) {
  # if (nrow(haul_cruises_maxyr)>1) {
  #   subobj <- ifelse(nrow(haul_cruises_maxyr)>1, TRUE, FALSE)
  #   newobj <- ifelse(i==1, TRUE, FALSE)
  # }
  # header <- paste0("Biomass estimates (t) for major fish species and groups taken during the ", 
  #                  maxyr, " ", 
  #                  haul_cruises_maxyr$SRVY_long[i],
  #                  " shelf bottom trawl survey.")
  
  nickname <- paste0(nickname0, haul_cruises_maxyr$SRVY[i]) 
# Select data and make plot
  table_raw<-species_table(table_list, haul_maxyr_spp, spp_common, SURVEY, SRVY = SRVY) 
  table_print <- table_raw %>%
          format_cells(rows = 0, # make column names
                       cols = 1:ncol(table_list[[length(table_list)]]$print), # for all columns
                       fonttype = "bold") %>% # bold
          knitr::kable(row.names = FALSE, booktabs = TRUE) #print table in text
  
  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
#   res <- knitr::knit_child(
#     text = knitr::knit_expand(
#       file = system.file("rmd/_child_save_tab.Rmd", package = "NMFSReports")), 
#     quiet = TRUE
#   )
#   
# list_tables[length(list_tables)]$res <- res <- paste0("
# ###### 
# 
# ",res,"
# 
# ")
#   
#   assign(value = res, x = paste0(nickname))
}
```


`r species_text(haul_maxyr, dat_maxyr_1, basiccontenttable_print, haul_maxyr_spp, length_maxyr, length_type, spp_common, spp_code, SRVY, cnt_figures) `

`r  ifelse(SRVY %in% "NEBS", "## **NBS**", "") `

  
`r ifelse(SRVY %in% "NEBS", species_text(haul_maxyr %>% dplyr::filter(SRVY %in% "NBS"), dat_maxyr_1 %>% dplyr::filter(year %in% (maxyr-1) & SRVY %in% "NBS"), basiccontenttable_print_nbs, haul_maxyr_spp %>% dplyr::filter(SRVY %in% "NBS"), length_maxyr %>% dplyr::filter(SRVY %in% "NBS"), length_type, spp_common, spp_code, SRVY = "NBS", cnt_figures), "") `  

`r  ifelse(SRVY %in% "NEBS", "## **EBS**", "") `
  
```{r}

if (SRVY %in% "NEBS" && sum(haul_maxyr_spp$SRVY %in% "EBS")>0) {
  # print("NBS")
  table_list<-species_table(table_list, 
                            haul_maxyr_spp %>% dplyr::filter(SRVY %in% "EBS"), 
                            spp_common, SURVEY, SRVY = "EBS") 
    # basiccontenttable_print_ebs <- table_list[[length(table_list)]]$print
    table_list[[length(table_list)]]$print  %>%
          format_cells(rows = 0, # make column names
                       cols = 1:ncol(table_list[[length(table_list)]]$print), # for all columns
                       fonttype = "bold") %>% # bold
          knitr::kable(row.names = FALSE, booktabs = TRUE) #print table in text
}
```


`r ifelse(SRVY %in% "NEBS", species_text(haul_maxyr %>% dplyr::filter(SRVY %in% "EBS"), dat_maxyr_1 %>% dplyr::filter(SRVY %in% "EBS"), basiccontenttable_print_ebs, haul_maxyr_spp %>% dplyr::filter(SRVY %in% "EBS"), length_maxyr %>% dplyr::filter(SRVY %in% "EBS"), length_type, spp_common, spp_code, SRVY = "EBS", cnt_figures), "") `


```{r}
#text
insert <- readtext(file = paste0(dir_out_rawdata, "/doc_",spp_common,".docx"))
```

`r insert$text`

```{r}
# str <- c()
# # if NEBS, then write for NBS and EBS
# if (SRVY %in% "NEBS") {
#   
#   str <- paste0("**NBS**
#                 ", 
#                 species_text(haul_maxyr %>% dplyr::filter(SRVY %in% "NBS"), 
#                       dat_maxyr_1 %>% dplyr::filter(SRVY %in% "NBS"), 
#                       basiccontenttable_print_nbs, 
#                       haul_maxyr_spp %>% dplyr::filter(SRVY %in% "NBS"), 
#                       length_maxyr %>% dplyr::filter(SRVY %in% "NBS"), 
#                       length_type, 
#                       spp_common, 
#                       spp_code, 
#                       SRVY = "NBS",
#                       cnt_figures), 
#          "**EBS**
#          ", 
#          species_text(haul_maxyr %>% dplyr::filter(SRVY %in% "EBS"), 
#                       dat_maxyr_1 %>% dplyr::filter(SRVY %in% "EBS"), 
#                       basiccontenttable_print_ebs, 
#                       haul_maxyr_spp %>% dplyr::filter(SRVY %in% "EBS"), 
#                       length_maxyr %>% dplyr::filter(SRVY %in% "EBS"), 
#                       length_type, 
#                       spp_common, 
#                       spp_code, 
#                       SRVY = "EBS",
#                       cnt_figures)
#          )
#   print(str)
#   
# }



# <!-- <!-- how many stations --> -->
# <!-- <!-- Should I use haul or hauljoin? --> -->
# <!-- Out of the total number of successful hauls (`r length(unique(haul_maxyr$hauljoin))`) `r NMFSReports::tolower2(spp_common)` was found during `r length(unique(haul_maxyr_spp$hauljoin))` (`r formatC(x = (length(unique(haul_maxyr_spp$hauljoin))/length(unique(haul_maxyr$hauljoin)))*100, digits = 1, format = "f") `% of stations). -->
# 
# <!-- During the `r maxyr` survey, `r NMFSReports::tolower2(spp_common)` were present at `r formatC(x = (length(unique(haul_maxyr_spp$hauljoin))/length(unique(haul_maxyr$hauljoin)))*100, digits = 1, format = "f") `% of stations in the `r SRVY` (`r length(unique(haul_maxyr_spp$hauljoin))` of `r length(unique(haul_maxyr$hauljoin))` stations). -->
# 
# 
# <!-- <!-- bottom tempature --> -->
# <!-- `r NMFSReports::tolower2(spp_common, capitalizefirst = TRUE)` were found in bottom temperatures as warm as `r as.numeric(basiccontenttable_print %>% dplyr::filter(Metric == "Surface Temperature") %>% dplyr::select(Max)) `°C and as cold as `r as.numeric(basiccontenttable_print %>% dplyr::filter(Metric == "Surface Temperature") %>% dplyr::select(Min)) `°C (Figure 7). -->
# 
# <!-- <!-- surface temperature --> -->
# <!-- `r NMFSReports::tolower2(spp_common, capitalizefirst = TRUE)` were found in areas where surface temperatures were as warm as `r as.numeric(basiccontenttable_print %>% dplyr::filter(Metric == "Bottom Temperature") %>% dplyr::select(Max)) `°C and as cold as `r as.numeric(basiccontenttable_print %>% dplyr::filter(Metric == "Bottom Temperature") %>% dplyr::select(Min)) `°C (Figure 7). -->
# 
# <!-- <!-- Depth --> -->
# <!-- They were found in waters with depths between `r as.numeric(basiccontenttable_print %>% dplyr::filter(Metric == "Bottom Depth") %>% dplyr::select(Min)) ` m and `r as.numeric(basiccontenttable_print %>% dplyr::filter(Metric == "Bottom Depth") %>% dplyr::select(Max)) ` m.   -->
# 
# 
# <!-- <!-- Sizes caught were between  --> -->
# <!-- The `r NMFSReports::text_list(length_type$sentancefrag[length_type$code %in% unique(length_maxyr$length_type)])` of `r NMFSReports::tolower2(spp_common, capitalizefirst = TRUE)` measured during the survey were between `r min(length_maxyr$length)` and `r max(length_maxyr$length)` `r unique(dplyr::case_when(spp_code %in% 1:31550 ~ "cm", spp_code %in% 68000:69930 ~ "mm"), TRUE ~ "NO MEASUREMENT")`. -->
# 
# 
# <!-- <!-- weight --> -->
# <!-- The total number of `r NMFSReports::tolower2(spp_common)` estimated to have been caught by the survey is `r NMFSReports::xunits(value = sum(haul_maxyr_spp$number_fish, na.rm = TRUE))` individuals, which equates to `r NMFSReports::xunits(value = sum(haul_maxyr_spp$weight, na.rm = TRUE))` kg of biomass.  -->
# 
# <!-- Compared with `r maxyr-1`, abundance experienced `r NMFSReports::pchange(start = sum(dat_maxyr_1_spp$number_fish, na.rm = TRUE), end = sum(haul_maxyr_spp$number_fish, na.rm = TRUE)) ` and there was `r NMFSReports::pchange(start = sum(dat_maxyr_1_spp$weight, na.rm = TRUE), end = sum(haul_maxyr_spp$weight, na.rm = TRUE)) ` in biomass.  -->
```


```{r fig_cpue_spp_ }
nickname0 <- paste0("fig_cpue_", spp_common)
header <- paste0("CPUE of **", NMFSReports::tolower2(spp_common), "** (*", stringr::str_to_sentence(spp_sci), "*) across the ", SURVEY)
height = 12

cpue_spp <- cpue %>% 
  filter(species_code %in% spp_code & 
           year %in% maxyr)

# if (length(SRVY1) > 1 && SRVY %in% "NEBS") {
# 
#   dat_cpue_spp_n <- cpue_spp %>%
#     dplyr::filter(survey == "NBS")
# 
#   idwplot <- make_idw_map0(COMMON_NAME = dat_cpue_spp_n$species_name,
#                          LATITUDE = dat_cpue_spp_n$latitude,
#                          LONGITUDE = dat_cpue_spp_n$longitude,
#                          CPUE_KGHA = dat_cpue_spp_n$cpue_kgha,
#                          region = "bs.north",
#                          key.title = spp_common)
# 
#   plot0 <- idwplot$plot +
#     theme(legend.position = "left",
#     panel.background = element_rect(fill = "transparent"), # bg of the panel
#     plot.background = element_rect(fill = "transparent", color = NA), # bg of the plot
#     panel.grid.major = element_blank(), # get rid of major grid
#     panel.grid.minor = element_blank(), # get rid of minor grid
#     legend.background = element_rect(fill = "transparent"), # get rid of legend bg
#     legend.box.background = element_rect(fill = "transparent") # get rid of legend panel bg
#   )
# 
# }

idwplot <- akgfmaps::make_idw_map(COMMON_NAME = cpue_spp$species_name, 
                         LATITUDE = cpue_spp$latitude, 
                         LONGITUDE = cpue_spp$longitude, 
                         CPUE_KGHA = cpue_spp$cpue_kgha, 
                         region = map.area, 
                         key.title = spp_common)
idwplot <- idwplot %>% change_fill_color(new.scheme = "grey", show.plot = FALSE)

plot0 <- idwplot$plot + 
  theme(#legend.position = "right", 
        legend.text = element_text(size = 8), 
        legend.background = element_blank(),
        legend.title = element_text(size = 8), 
        plot.margin = unit(c(0,0,0,0), "cm")) + 
  geom_shadowtext(data = subset(placenames, type %in% c("bathymetry", "islands")),
    aes(x = x, y = y, label = lab), bg.color = "white", color = "black", size = 3, group = 99) + 
  geom_shadowtext(data = subset(placenames, type %in% c("convention line", "peninsula")),
    aes(x = x, y = y, label = lab, angle = 43), bg.color = "white", color = "black", size = 3, group = 99) + 
      geom_shadowtext(data = subset(placenames, type %in% c("mainland")),
      aes(x = x, y = y, label = lab), bg.color = "white", color = "black", size = 8, group = 99)  

if (!(map.area %in% c("nbs", "bs.north"))) {
  plot <- plot + 
      geom_shadowtext(data = subset(placenames, type %in% c("mainland")),
      aes(x = x, y = y, label = lab), bg.color = "white", color = "black", size = 8, group = 99)  
}


```



 ## fig_idw_bottemp_longterm_mean_ (above and below)

> need to figure out how to plot bs.all and bs.south on same stars_list facet_wrap

```{r fig_idw_bottemp_longterm_mean_}
nickname0 <- "fig_idw_bottemp_longterm_mean_"

for (i in 1:2) { # two cases, above and below
  width = 6
  height = 6
  usePNGPDF = "png"  
  
  subobj <- TRUE
  newobj <- ifelse(i==1, TRUE, FALSE)
  TF <- ifelse(i==1, FALSE, TRUE)
  case <- ifelse(i==1, "below", "above")
  
  header <- paste0("Contour maps of ",spp_common," (*",spp_sci,"*) the near-bottom temperatures from the ",
                   NMFSReports::text_list(sort(temps_wt_avg_yr_abovebelow_plots[,case])),
                   " Bering Sea shelf bottom trawl surveys, years when the survey mean bottom temperature was ",
                   case,
                   " the long-term stratum area-weighted mean.")
  footnote<- NA
  nickname <- paste0(nickname0, case)
  alttext <- paste0(header)
  
  table_raw <- haul %>%
      dplyr::filter(!is.na(gear_temperature)) %>% 
      dplyr::arrange(-year) 
  
  figure <- plot_idw_xbyx(
    yrs = temps_wt_avg_yr_abovebelow_plots[,case], 
    dat = table_raw,
    cruises = cruises, 
    lat = "start_latitude",
    lon = "start_longitude",
    var = "gear_temperature", 
    grid = "continuous.grid",
    extrap.box = extrap.box, 
    key.title = "Bottom Temperature (°C)", 
    workfaster = workfaster, 
    SRVY = SRVY)

  # save yo' stuff and do a lot of behind the scenes work
  # alt: this does the same thing as calling "child = " in the chunk header
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = system.file("rmd/_child_save_fig.Rmd", 
                         package = "NMFSReports")), 
    quiet = TRUE
  )
  
list_figures[length(list_figures)]$res <- res <- paste0("
###### 

",res,"

")
  
  assign(value = res, x = nickname)
}

```
