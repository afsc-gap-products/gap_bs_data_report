---
output:
  officedown::rdocx_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, error = FALSE, message = FALSE)
```

## vars

```{r vars}
a <- report_spp1[which(report_spp1$file_name == unique(comb$file_name)[jj]), ]

spp_sci <- a$species_name[1]
spp_sci1 <- a$species_name1[1]
spp_code <- a$species_code
spp_print <- a$print_name[1]
spp_file <- a$file_name[1]
spp_taxon <- a$taxon[1]

# report_title == "community"
dataTcommF <- FALSE
spp_plot_sizecomp <- a$plot_sizecomp[1]
spp_plot_idw <- a$plot_idw[1]
spp_plot_pa <- FALSE
spp_table_cpue <- FALSE
spp_text <- TRUE

if (report_title == "data") {
  dataTcommF <- TRUE
  # spp_plot_pa <- a$plot_pa[1]
  spp_table_cpue <- a$table_cpue[1]
  spp_text <- a$text_spp[1]
}
```

## fig-[spp]

```{r fig-[spp]}
header <- paste0("Image of the  ", 
                 maxyr ," ", SURVEY ," bottom trawl survey", 
                 ifelse(length(SRVY1)>1, "s", ""), ".")
footnote<- NA
nickname <- paste0("fig-", spp_file)
alttext <- paste0(header)
height = 8
width <- full_page_portrait_width

# Select data and make plot
figure <- 
  cowplot::ggdraw() +
  cowplot::draw_image(readPNG(paste0(dir_img, spp_file, ".png")) )

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)
```

## fig-dist-[taxon]-[spp]

```{r dist_funct} 
make_idw_stack <- function (x = NA, COMMON_NAME = NA, LATITUDE = NA, LONGITUDE = NA, 
          CPUE_KGHA = NA, region = "bs.south", extrap.box = NULL, extrapolation.grid.type = "stars", 
          set.breaks = "jenks", grouping.vars, grid.cell = c(5000, 
                                                             5000), in.crs = "+proj=longlat", out.crs = "EPSG:3338", 
          log.transform = FALSE, idw.nmax = 4, use.survey.bathymetry = TRUE) 
{
  stopifnot(`make_idw_map: extra.grid.type must be 'stars', 'sf', or 'sf.simple'` = extrapolation.grid.type %in% 
              c("stars", "sf", "sf.simple"))
  if (!is.data.frame(x)) {
    stopifnot(`make_idw_map: LATITUDE must be a numeric vector.` = is.numeric(LATITUDE))
    stopifnot(`make_idw_map: LONGITUDE must be a numeric vector.` = is.numeric(LONGITUDE))
    stopifnot(`make_idw_map: CPUE_KGHA must be a numeric vector.` = is.numeric(CPUE_KGHA))
    x <- data.frame(COMMON_NAME = COMMON_NAME, LATITUDE = LATITUDE, 
                    LONGITUDE = LONGITUDE, CPUE_KGHA = CPUE_KGHA)
  }
  map_layers <- akgfmaps::get_base_layers(select.region = region, 
                                          set.crs = out.crs)
  if (is.null(extrap.box)) {
    extrap.box <- sf::st_bbox(map_layers$survey.area)
  }
  if (out.crs == "auto") {
    out.crs <- map_layers$crs
  }
  if (use.survey.bathymetry) {
    map_layers$bathymetry <- akgfmaps::get_survey_bathymetry(select.region = region, 
                                                             set.crs = out.crs)
  }
  extrap_raster <- terra::rast(xmin = extrap.box["xmin"], xmax = extrap.box["xmax"], 
                               ymin = extrap.box["ymin"], ymax = extrap.box["ymax"], 
                               ncol = (extrap.box["xmax"] - extrap.box["xmin"])/grid.cell[1], 
                               nrow = (extrap.box["ymax"] - extrap.box["ymin"])/grid.cell[2], 
                               crs = out.crs)
  loc_df <- sf::st_as_sf(suppressWarnings(terra::crds(extrap_raster, 
                                                      df = TRUE, na.rm = FALSE)), coords = c("x", "y"), crs = out.crs)
  unique_groups <- unique(dplyr::select(x, dplyr::all_of(grouping.vars)))
  
  x <- sf::st_transform(sf::st_as_sf(x, coords = c(x = "LONGITUDE", 
                                                   y = "LATITUDE"), 
                                     crs = sf::st_crs(in.crs)), crs = map_layers$crs)
  for (ii in 1:nrow(unique_groups)) {
    if (length(grouping.vars) > 1) {
      x_sub <- dplyr::inner_join(x, unique_groups[ii, ], by = grouping.vars)
    } else {
      x_sub <- x[which(x[[grouping.vars]] == unlist(unique_groups[ii,])), ]
    }
    idw_fit <- gstat::gstat(formula = CPUE_KGHA ~ 1, locations = x_sub, nmax = idw.nmax)
    stn.predict <- predict(idw_fit, x_sub)
    extrap.grid <- sf::st_join(stars::st_rasterize(sf::st_transform(predict(idw_fit, 
                                                                            loc_df), crs = sf::st_crs(x))), map_layers$survey.area, 
                               join = st_intersects)
    alt.round <- 0
    if (is.character(set.breaks[1])) {
      set.breaks <- tolower(set.breaks)
      break.vals <- classInt::classIntervals(x$CPUE_KGHA, 
                                             n = 5, style = set.breaks)$brks
      alt.round <- floor(-1 * (min((log10(break.vals) - 
                                      2)[abs(break.vals) > 0])))
      set.breaks <- c(-1, round(break.vals, alt.round))
    }
    if (min(set.breaks) > 0) {
      set.breaks <- c(0, set.breaks)
    }
    if (min(set.breaks) == 0) {
      set.breaks <- c(-1, set.breaks)
    }
    if (max(set.breaks) < max(x$CPUE_KGHA)) {
      set.breaks[length(set.breaks)] <- max(x$CPUE_KGHA) + 1
    }
    dig.lab <- 7
    set.levels <- cut(x$CPUE_KGHA, set.breaks, right = TRUE, 
                      dig.lab = dig.lab)
    if (alt.round > 0) {
      while (dig.lab > alt.round) {
        dig.lab <- dig.lab - 1
        set.levels <- cut(x$CPUE_KGHA, set.breaks, right = TRUE, 
                          dig.lab = dig.lab)
      }
    } else {
      while (length(grep("\\.", set.levels)) > 0) {
        dig.lab <- dig.lab - 1
        set.levels <- cut(x$CPUE_KGHA, set.breaks, right = TRUE, 
                          dig.lab = dig.lab)
      }
    }
    continuous.grid <- extrap.grid
    continuous.grid <- continuous.grid["var1.pred"]
    names(continuous.grid) <- paste(unique_groups[ii, ], 
                                    collapse = "_")
    extrap.grid$var1.pred <- cut(extrap.grid$var1.pred, set.breaks, 
                                 right = TRUE, dig.lab = dig.lab)
    sig.dig <- round(set.breaks[which(nchar(round(set.breaks)) >= 
                                        4)])
    make_level_labels <- function(vec) {
      vec <- as.character(vec)
      vec[grep("-1", vec)] <- "No catch"
      vec <- sub("\\(", "\\>", vec)
      vec <- sub("\\,", "–", vec)
      vec <- sub("\\]", "", vec)
      if (length(sig.dig) > 3) {
        for (j in 1:length(sig.dig)) {
          vec <- sub(sig.dig[j], format(sig.dig[j], nsmall = 0, 
                                        big.mark = ","), vec)
        }
      }
      return(vec)
    }
    extrap.grid$var1.pred <- factor(make_level_labels(extrap.grid$var1.pred), 
                                    levels = make_level_labels(levels(set.levels)))
    if (ii == 1) {
      continuous.stack <- continuous.grid
    } else {
      continuous.stack <- c(continuous.stack, continuous.grid)
    }
    if (extrapolation.grid.type %in% c("sf", "sf.simple")) {
      extrap.grid <- sf::st_intersection(dplyr::summarise(dplyr::group_by(dplyr::select(sf::st_as_sf(extrap.grid), 
                                                                                        -var1.var), var1.pred), n = n()), map_layers$survey.area)
      extrap.grid <- dplyr::select(extrap.grid, which(names(extrap.grid) %in% 
                                                        c("var1.pred", "n", "SURVEY", "geometry")))
      if (length(grouping.vars) > 1) {
        extrap.grid <- dplyr::bind_cols(extrap.grid, 
                                        unique_groups[ii, ])
      } else {
        extrap.grid[grouping.vars] <- unique_groups[ii, ]
      }
      if (extrapolation.grid.type == "sf.simple") {
        extrap.grid <- rmapshaper::ms_simplify(extrap.grid, 
                                               keep_shapes = TRUE, keep = 0.04)
      }
      if (ii == 1) {
        extrap.stack <- extrap.grid
      } else {
        extrap.stack <- dplyr::bind_rows(extrap.stack, 
                                         extrap.grid)
      }
    } else {
      extrap.grid <- extrap.grid["var1.pred"]
      names(extrap.grid) <- paste(unique_groups[ii, ], collapse = "_")
      if (ii == 1) {
        extrap.stack <- extrap.grid
      } else {
        extrap.stack <- c(extrap.stack, extrap.grid)
      }
    }
  }
  return(list(map_layers = map_layers, extrapolation.stack = extrap.stack, 
              continuous.stack = continuous.stack, region = region, 
              crs = out.crs))
}


```


```{r fig-dist-[taxon]-[spp]}

if (spp_plot_idw | spp_plot_pa) {
  
  width <- full_page_portrait_width # 6.5  
  case_yr0 <- 1
  nickname <- paste0("fig-dist-", spp_taxon, "-", spp_file)
  if (report_title == "data") {
    yrs <- c(compareyr, maxyr)
    height <- ifelse(SRVY == "NEBS", 5.5, 4.25) 
    row0 <- 1
  } else if (report_title == "community") {
    yrs <- nbsyr
    height <- full_page_portrait_height-1
    row0 <- 2
    nickname <- paste0(nickname, "-comm")
  } 
  
  if (spp_plot_idw) {
    
    table_raw <- cpue %>% 
      dplyr::mutate(cpue_kgkm2 = ifelse(is.na(cpue_kgkm2), 0, cpue_kgkm2)) %>%
      dplyr::filter(
        SRVY %in% SRVY1 &
          species_code %in% spp_code & 
          year %in% yrs) %>% 
      dplyr::arrange(desc(year))
    
    spp_plot_pa <- ifelse(nrow(table_raw)<2, TRUE, spp_plot_pa)
    spp_plot_idw <- ifelse(isTRUE(spp_plot_pa), FALSE, spp_plot_idw)
  }  
  
  if (spp_plot_pa) {
    
    table_raw <- catch_haul_cruises %>%
      dplyr::filter(!is.na(count) & 
                      SRVY %in% SRVY1 &
                      count != 0 & 
                      species_code %in% spp_code & 
                      year %in% yrs) %>% 
      dplyr::arrange(desc(year))
  }
  
  # only if both species are only found in prt of the region, chnge the extrp.box
  map.area0 <- map.area
  reg_dat0 <- reg_dat
  if (length(unique(table_raw$SRVY))==1 & SRVY == "NEBS") { # is this species in only 1 of the 2 survey areas (when SRVY == NEBS)?
    map.area0 <- ifelse(unique(table_raw$SRVY) == "EBS", "bs.south", "bs.north")
    reg_dat0 <- report_types[[unique(table_raw$SRVY)]]$reg_dat
    height <- ifelse(reg_dat0$survey.area$SURVEY == "EBS_SHELF" & 
                       report_title == "data", 4.25, 3.5)
  }
  
  header0 <- paste0(spp_print, 
                    ifelse(is.na(spp_sci), "", 
                           paste0(" (",spp_sci,")")), 
                    " from the ",
                    range_text(yrs), " ", 
                    SURVEY, 
                    # ifelse(length(unique(table_raw$SRVY)) > 1, "eastern and northern Bering Sea", 
                    #        haul_cruises_maxyr$SRVY_long[haul_cruises_maxyr$SRVY == unique(table_raw$SRVY)]),
                    " shelf bottom trawl survey", 
                    ifelse(length(unique(table_raw$SRVY))>1, "s", ""), ". ", 
                    ifelse(length(unique(table_raw$SRVY)) > 1 & SRVY == "NEBS", 
                           "", 
                           paste0("This species was not encountered in the ", 
                                  range_text(yrs), " ",
                                  haul_cruises_maxyr$SRVY_long[haul_cruises_maxyr$SRVY != unique(table_raw$SRVY)], 
                                  " shelf bottom trawl survey", ifelse(length(yrs)>1, "s", ""), 
                                  ". ")))
  
  for (case_yr in case_yr0) {
    if (length(case_yr0)>1) {
      if (case_yr == 1) {
        yrs <- yrs0[1:(length(yrs0)/2)]
      } else if (case_yr == 2) {
        yrs <- yrs0[((length(yrs0)/2)+1):length(yrs0)]
      }
    }
    
    if (spp_plot_idw) {
      
      header <- paste0("The distribution (weight_kg CPUE (kg/km^2^)) of ", 
                       header0)
      
      # figure <- plot_idw_facet(
      #   yrs = yrs,
      #   dat = table_raw, 
      #   lat = "latitude_dd_start",
      #   lon = "longitude_dd_start",
      #   var = "cpue_kgkm2",
      #   year = "year",
      #   grid = "continuous.grid",
      #   reg_dat = reg_dat0, 
      #   region = map.area0, 
      #   key.title = paste0(stringr::str_to_sentence(spp_print), "\nWeight CPUE (kg/km2)"),
      #   row0 = row0, 
      #   legend_srvy_reg = FALSE) 

      set.breaks <- set_breaks(dat = table_raw, var = "cpue_kgkm2")
      
      a <- make_idw_stack(
        x = table_raw %>% 
          dplyr::rename(COMMON_NAME = common_name,
        LATITUDE = latitude_dd_start,
        LONGITUDE = longitude_dd_start,
        CPUE_KGHA = cpue_kgkm2),
        region = map.area0, 
        grouping.vars = "year", 
        set.breaks = set.breaks)
    
      # row0 <- 1 
      
      stars0 <- stars::st_redimension(a$extrapolation.stack) # continuous.stack
      viridis_palette_option <- "mako"
      key.title <- paste0(stringr::str_to_sentence(spp_print), "\nWeight CPUE (kg/km2)")
        legend_srvy_reg <- TRUE
        
  figure <- ggplot() +
    geom_sf(data = reg_dat$akland,
            color = NA,
            fill = "grey50")  +
    geom_sf(data = reg_dat$graticule,
            color = "grey80",
            alpha = 0.2) +
    ggplot2::scale_y_continuous(name = "", #"Latitude",
                                limits = reg_dat$plot.boundary$y,
                                breaks = reg_dat$lat.breaks) +
    ggplot2::scale_x_continuous(name = "", #"Longitude",
                                limits = reg_dat$plot.boundary$x,
                                breaks = reg_dat$lon.breaks) +
    geom_stars(data = stars0,
                       na.rm = FALSE,
                       show.legend = TRUE) +
      facet_wrap( ~ new_dim, nrow = row0) + 
      coord_sf() + 
      ggplot2::scale_fill_manual(
        name = key.title, 
        values =  c("gray90",
                    viridis::viridis(
                      option = viridis_palette_option,
                      direction = -1,
                      n = length(set.breaks)-1,
                      begin = 0.20,
                      end = 0.80)),
        na.translate = FALSE, # Don't use NA
        drop = FALSE)  +
    ggplot2::geom_sf(
      data = reg_dat$survey.area, 
      mapping = aes(color = SURVEY, 
                    geometry = geometry), 
      fill = "transparent", 
      linewidth = ifelse(row0 > 2, 1.5, 1), # size
      show.legend = legend_srvy_reg) +
    ggplot2::scale_color_manual(
      name = " ", 
      values = reg_dat$survey.area$color,
      breaks = reg_dat$survey.area$SURVEY,
      labels = reg_dat$survey.area$SRVY) + 
    ggplot2::guides(
      fill = guide_legend(
        order = 1,
        title.position = "top",
        label.position = "bottom",
        title.hjust = 0.5,
        override.aes = list(color = NA),
        nrow = 1),
      color = guide_legend(
        order = 2, 
        label.position = "right",
        override.aes = list(
          fill = reg_dat$survey.area$color, 
          color = reg_dat$survey.area$color), 
        title.hjust = 0.5,
        nrow = 2))  +
    #set legend position and vertical arrangement
    ggplot2::theme( 
      panel.background = element_rect(fill = "white", 
                                      colour = NA), 
      panel.border = element_rect(fill = NA, 
                                  colour = "grey20"), 
      axis.text = element_text(size = ifelse(length(yrs)>4 & row0 == 1, 6, 8)),
      
      strip.background = element_blank(), 
      strip.text = element_text(size = 10, face = "bold"), 
      legend.text = element_text(size = 9),
      legend.background = element_rect(colour = "transparent", 
                                       fill = "transparent"),
      legend.key = element_rect(colour = "transparent", 
                                fill = "transparent"),
      legend.position = "bottom", 
      legend.box = "horizontal") 
      
    } else if (spp_plot_pa) {
      header <- paste0("The presence of ", header0)
      
      table_raw0 <- catch_haul_cruises %>%
        dplyr::filter(!is.na(count) &
                        count != 0 &
                        species_code %in% spp_code &
                        year %in% yrs &
                        SRVY %in% unique(table_raw$SRVY)) %>%
        dplyr::select(SRVY, year, latitude_dd_start, longitude_dd_start, count, species_code) 
      
      figure <- plot_pa_facet(
        yrs = yrs,
        dat = table_raw0,
        lat = "latitude_dd_start",
        lon = "longitude_dd_start",
        year = "year",
        reg_dat = reg_dat0, 
        key.title = paste0(stringr::str_to_sentence(spp_print), " presence"),
        row0 = row0, 
        legend_srvy_reg = FALSE)
    }
    
    # if (!(pres_img) & report_title == "community") {
    #   
    #   figure <-
    #     cowplot::ggdraw(figure) +
    #     cowplot::draw_image(image = readPNG(paste0(dir_img, spp_file, ".png")),
    #                         x = 0.75, y = -0.05,
    #                         hjust = 0, vjust = 0,
    #                         width = .18)
    # }
    
    # Save figure
    res <- knitr::knit_child(
      text = knitr::knit_expand(
        file = paste0(dir_code, "_child_save_figtab.Rmd")), 
      quiet = TRUE
    )
  }
}
```

## fig-sizecomp-[taxon]-[spp]

```{r fig-sizecomp-[taxon]-[spp]}
if (spp_plot_sizecomp) {
  
  width <- full_page_portrait_width # 6.5  
  nickname <- paste0("fig-sizecomp-", spp_taxon, "-", spp_file)
  
  if (report_title == "data") {
    yrs <- c(compareyr, maxyr)
    height <- ifelse(SRVY == "NEBS", full_page_portrait_height-1, 3.25) 
    print_n <- FALSE
    SRVY11 <- SRVY1
  } else if (report_title == "community") {
    yrs <- nbsyr
    height <- full_page_portrait_height
    print_n <- TRUE
    SRVY11 <-"NBS"
    nickname <- paste0(nickname, "-comm")
  }

  lengths0 <- lengths %>%
    dplyr::filter(species_code %in% spp_code &
                    SRVY %in% SRVY11 &
                    year %in% yrs)
  
  type <- unique(lengths0$sentancefrag)
  
  table_raw <- sizecomp %>%
    dplyr::filter(species_code %in% spp_code &
                    SRVY %in% SRVY11 &
                    year %in% yrs) %>% 
    dplyr::mutate(sex = str_to_sentence(sex), 
                  sex = factor(sex, 
                               levels = c("Unsexed", "Males", "Females", "Immature females", "Mature females"), 
                               labels = c("Unsexed", "Males", "Females", "Immature females", "Mature females"),
                               ordered = TRUE), 
                  SRVY_long = dplyr::case_when(
                    SRVY == "EBS" ~ "eastern Bering Sea", 
                    SRVY == "NBS" ~ "northern Bering Sea")) %>% 
    dplyr::arrange(sex)
  
  if (report_title != "community" & SRVY == "NEBS" & length(unique(table_raw$SRVY))>1) {
    
    table_raw <- dplyr::bind_rows(
      table_raw, 
      table_raw %>%
        dplyr::filter(species_code %in% spp_code &
                        SRVY %in% SRVY &
                        year %in% yrs) %>% 
        dplyr::group_by(year, taxon, species_code, sex, population_count) %>% 
        dplyr::summarise(length_mm) %>% 
        dplyr::mutate(
          SRVY = factor(x = SRVY, levels = c("EBS", "NBS", "EBS and NBS"), ordered = TRUE), 
          SRVY = "EBS and NBS", 
          SRVY_long = paste0("combined ", SURVEY)))
    
  } else if (report_title != "community" & SRVY == "NEBS" & length(unique(table_raw$SRVY))==1) { 
    height <- 3.25 
  }
  
  header <- paste0("Total abundance-at-length estimates of ",
                   spp_print, ifelse(is.na(spp_sci), "", 
                                     paste0(" (",spp_sci,")")), 
                   " by sex (",text_list(tolower(unique(table_raw$sex))),
                   ") in ",
                   ifelse(!grepl(pattern = " crab", x = spp_print, ignore.case = TRUE), 
                          "centimeters (cm)", "millimeters (mm)"),
                   " encountered during the ",
                   range_text(yrs)," ",
                   text_list(paste0(unique(table_raw$SRVY_long), " (", unique(table_raw$SRVY), ")")), 
                   " shelf bottom trawl survey", 
                   ifelse(length(unique(table_raw$SRVY))==1 & length(unique(table_raw$year))==1, "", "s"),
                   ". ",
                   ifelse(length(setdiff(SRVY1, unique(table_raw$SRVY)))>0,
                          paste0("There were no lengths collected for this species in the ", 
                                 range_text(yrs), " ",
                                 haul_cruises_maxyr$SRVY_long[haul_cruises_maxyr$SRVY != unique(table_raw$SRVY)],
                                 " shelf trawl survey",ifelse(length(yrs)>1, "s", ""),". "), 
                          ""),
                   
                   "Length distributions scaled up to the total estimated population_count size. ", 
                   ifelse(print_n, 
                          "Total number of individuals measured during the survey is indicated in the upper right corner of each plot.", ""))
  
  figure <- plot_sizecomp(
    sizecomp0 = table_raw,
    lengths0 = lengths0,
    spp_code = spp_code,
    spp_print = stringr::str_to_sentence(spp_print),
    type = type,
    print_n = print_n)
  
  # if (!(pres_img) & report_title == "community") {
  #   
  #   figure <-
  #     cowplot::ggdraw(figure) +
  #     cowplot::draw_image(image = readPNG(paste0(dir_img, spp_file, ".png")),
  #                         x = 0.07, y = -.42,
  #                         hjust = 0, vjust = 0,
  #                         width = .18)
  # }
  
  # Save figure
  res <- knitr::knit_child(
    text = knitr::knit_expand(
      file = paste0(dir_code, "_child_save_figtab.Rmd")), 
    quiet = TRUE
  )
  
}
```

## tab-env-[taxon]-[spp]

```{r tab-env-[taxon]-[spp]}

nickname <- paste0("tab-env-", spp_taxon, "-", spp_file)

haul0 <- catch_haul_cruises %>% 
  dplyr::select("station", "stratum", "latitude_dd_start", "longitude_dd_start", 
                "depth_m", "bottom_temperature_c" ,"surface_temperature_c", 
                "survey_name", "SRVY", "year", "species_code", 
                "weight_kg", "count", "hauljoin")

header <- header1 <- paste0("Summary ranges of environmental variables that ", spp_print, " (", spp_sci, ") have been found in across the ", SURVEY, " survey area", plural_surveys,". ")

## Env table
stat <- dplyr::left_join(
  x = haul0 %>% 
    dplyr::filter(year == maxyr) %>% 
    dplyr::select(station, SRVY) %>% 
    dplyr::distinct() %>% 
    dplyr::select(SRVY) %>% 
    table() %>% 
    data.frame() %>% 
    dplyr::rename(tot = Freq), 
  y = haul0 %>% 
    dplyr::filter(species_code %in% spp_code & year == maxyr) %>% 
    dplyr::select(station, SRVY) %>% 
    dplyr::distinct() %>% 
    dplyr::select(SRVY) %>% 
    table() %>% 
    data.frame() %>% 
    dplyr::rename(spp = Freq), 
  by = "SRVY") %>% 
  dplyr::mutate(str = paste0(spp, "/", tot, 
                             " (", formatC(spp/tot*100, digits = 1, format = "f", big.mark = ","), "%)"))

table_raw <- haul0 %>% 
  dplyr::filter(SRVY %in% SRVY1 & 
                  year == maxyr & 
                  species_code %in% spp_code) %>% 
  dplyr::select(SRVY, 
                "Latitude (°N)" = latitude_dd_start, 
                "Longitude (°W)" = longitude_dd_start, 
                "Bottom Depth (m)" = depth_m, 
                "Bottom Temperature (°C)" = bottom_temperature_c, 
                "Surface Temperature (°C)" = surface_temperature_c) %>% 
  dplyr::group_by(SRVY) %>% 
  dplyr::summarise(across(where(is.numeric), .fns = 
                            list(Min = min,
                                 Max = max))) %>%
  tidyr::pivot_longer(is.numeric, 
                      names_sep='_',
                      names_to=c('variable', '.value')) %>% 
  dplyr::mutate(across(is.numeric, formatC, big.mark = ",", digits = 1, format = "f"), 
                val = paste0(Min, " ", 
                             gsub("[\\(\\)]", "", regmatches(variable, gregexpr("\\(.*?\\)", variable))), 
                             " – ",
                             Max,  " ", 
                             gsub("[\\(\\)]", "", regmatches(variable, gregexpr("\\(.*?\\)", variable))) )) %>%
  dplyr::relocate(variable, dplyr::ends_with(SRVY1[1])) %>% 
  dplyr::select(-Min, -Max) %>% 
  tidyr::pivot_wider(id_cols = "variable",
                     names_from = "SRVY",
                     values_from = c("val"))

table_print <- table_print1 <- table_raw %>%
  flextable::flextable(data = .) %>% 
  flextable::set_header_labels(
    values = eval(parse(text =
                          paste0("list(", paste0(names(table_raw), " = '",
                                                 c('Survey region:\nStations sampled:',
                                                   sort(rep_len(x = paste0(stat$SRVY, "\n", stat$str),
                                                                length.out = length(SRVY1)))), "'", 
                                                 collapse = ", "), ")"))) ) %>%
  flextable::merge_v(part = "header") %>%
  theme_flextable_nmfstm(row_lines = FALSE, 
                         font = font0, 
                         pad = 0, 
                         pgwidth = full_page_portrait_width) %>% 
  flextable::bold(j = 1, part = "body") %>% 
  # flextable::align(align = "right", part = "all") %>% 
  flextable::align(align = "center", part = "all")  %>% 
  flextable::align(align = "left", j = 1, part = "all") %>% 
  flextable::padding(part = "all", padding.right = 5) #%>% 
  # flextable::vline(x = ., j = 3, part = "all")

# Save table
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")),
  quiet = TRUE
)
```

## tab-bio-[taxon]-[spp]

```{r tab-bio-[taxon]-[spp]}

nickname <- paste0("tab-bio-", spp_taxon, "-", spp_file)

header <- header2 <- paste0("Summary biomass (t) and population ", spp_print, " (", spp_sci, ") estimates from the ", SURVEY, " survey area", plural_surveys,". ")


temp_bio <- dplyr::left_join(
  x = total_biomass %>% 
    dplyr::group_by(SRVY, year) %>% 
    dplyr::summarise(total = sum(total, na.rm = TRUE)), 
  y = biomass %>% 
    dplyr::filter(year %in% c(maxyr, compareyr) & 
                    species_code %in% spp_code[1] &
                    stratum %in% 999) %>%
    dplyr::select(SRVY, year, biomass_mt, population_count, cpue_kgkm2_mean, cpue_nokm2_mean) %>% 
    dplyr::mutate(print_name = spp_print) %>% 
    # dplyr::rename(cpue_kgkm2 = cpue_kgkm2_mean, 
    #               cpue_nokm2 = cpue_nokm2_mean) %>% 
    dplyr::filter((biomass_mt !=0)), 
  by = c("year", "SRVY"))

table_raw <- data.frame()
for (i in 1:nrow(temp_bio)) {
  
  table_raw  <- dplyr::bind_rows(
    table_raw, 
    c(
      SRVY = temp_bio$SRVY[i], 
      Year = temp_bio$year[i], 
      "Population\n" = xunits(sum(temp_bio$population_count[i], na.rm = TRUE), 
                              val_under_x_words = NULL), 
      "Biomass (t)\n" = paste0(xunits(sum(temp_bio$biomass_mt [i], na.rm = TRUE), 
                                      val_under_x_words = NULL), " t"), 
      "Biomass\n% of Total" = 
        paste0(formatC(x = (temp_bio$biomass_mt [i]/temp_bio$total[i])*100, 
                       digits = 1, format = "f", big.mark = ","), "%"), 
      "Biomass\n% Change" = ifelse(temp_bio$year[i] != maxyr, "", 
                                   sub(replacement = "", pattern = "an ", 
                                       x = gsub(pattern = "a ", replacement = "", 
                                                x = pchange(
                                                  start = temp_bio$biomass_mt [i], 
                                                  end = temp_bio$biomass_mt [temp_bio$year == compareyr])))))
  )
}

table_print <- table_print2 <- table_raw %>% 
  dplyr::arrange(SRVY) %>%
  dplyr::rename(" " = SRVY) %>% 
  flextable::flextable(data = .) %>% 
  flextable::merge_v(j = 1, part = "body") %>% 
  flextable::bold(j = 1, part = "body") %>% 
  flextable::bg(i = ~ grepl(x = `Biomass\n% Change`, pattern = "increase"), 
                bg = positive, 
                j = "Biomass\n% Change") %>% 
  flextable::bg(i = ~ grepl(x = `Biomass\n% Change`, pattern = "decrease"), 
                bg = negative, 
                j = "Biomass\n% Change")  %>%
  theme_flextable_nmfstm(row_lines = FALSE, 
                         font = font0, 
                         pad = 0, 
                         pgwidth = full_page_portrait_width) %>% 
  flextable::hline(i = 2, part = "body") %>% 
  flextable::padding(x = ., 
                     part = "body", 
                     padding.left = 5) 

# Save table
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")),
  quiet = TRUE
)
```

## tab-summary-[taxon]-[spp]

```{r tab-summary-[taxon]-[spp], eval = FALSE}

nickname0 <- paste0("tab-summary-", spp_taxon, "-", spp_file)

width <- full_page_portrait_width # 6.5  
height <- 4

header <- paste0("A) ", header1, "B) ", header2)

figure <- cowplot::plot_grid(
  ggplot2::ggplot() + 
    theme_void() + 
    annotation_custom(
      rasterGrob(table_print1 %>% 
                   flextable::as_raster()), xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf), 
  ggplot2::ggplot() + 
    theme_void() + 
    annotation_custom(
      rasterGrob(table_print2 %>% 
                   flextable::as_raster()), xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf), 
  nrow = 2, ncol = 1,
  labels = "AUTO") # , rel_heights = c(4, 1) 
figure <- cowplot::plot_grid(figure, 
                             ggdraw() + 
                               draw_image(here::here("img", paste0(spp_file, ".png")), scale = 0.9), 
                             nrow = 1, ncol = 2, rel_widths = c(6, 2)) 

# Save figure
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)

```


## tab-len-[taxon]-[spp]

```{r tab-len-[taxon]-[spp], eval = FALSE}

nickname0 <- paste0("tab-len-", spp_taxon, "-", spp_file)

lengths_maxyr0 <- lengths_maxyr %>% 
  dplyr::filter(species_code %in% spp_code) %>% 
  dplyr::select(SRVY, species_code, frequency, sex, length_mm,
                length_type, name, sentancefrag)

if (nrow(lengths_maxyr0) != 0) {
  
  unit <- unique(dplyr::case_when(lengths_maxyr0$species_code[1] %in% 1:31550 ~ 'cm', 
                                  lengths_maxyr0$species_code[1] %in% 68000:69930 ~ 'mm'), 
                 TRUE ~ 'NO MEASUREMENT')
  
  str0 <- paste0(
    "The ", text_list(unique(lengths_maxyr0$sentancefrag)), 
    " of ", spp_print, 
    " measured during the ",maxyr," ",
    ifelse(sum(SRVY1 %in% c("NBS", "EBS"))==2, "NEBS", SRVY1),
    " survey were between ", 
    (min(lengths_maxyr0$length_mm, na.rm = TRUE)/ifelse(unit == "cm", 10, 1)), 
    " and ",
    (max(lengths_maxyr0$length_mm, na.rm = TRUE)/ifelse(unit == "cm", 10, 1)), 
    " ", unit, " (Fig. `` `r fig_sizecomp` ``). ")
}

if (nrow(lengths_maxyr0) != 0) {
  
  unit <- unique(dplyr::case_when(lengths_maxyr0$species_code[1] %in% 1:31550 ~ 'cm', 
                                  lengths_maxyr0$species_code[1] %in% 68000:69930 ~ 'mm'), 
                 TRUE ~ 'NO MEASUREMENT')
  
  str0 <- paste0(
    "The ", text_list(unique(lengths_maxyr0$sentancefrag)), 
    " of ", spp_print, 
    " measured during the ",maxyr," ",
    ifelse(sum(SRVY1 %in% c("NBS", "EBS"))==2, "NEBS", SRVY1),
    " survey were between ", 
    (min(lengths_maxyr0$length_mm, na.rm = TRUE)/ifelse(unit == "cm", 10, 1)), 
    " and ",
    (max(lengths_maxyr0$length_mm, na.rm = TRUE)/ifelse(unit == "cm", 10, 1)), 
    " ", unit, " (Fig. `` `r fig_sizecomp` ``). ")
}

# return(str0)

# }

species_content <- function(SURVEY000, 
                            SRVY1, 
                            haul0, 
                            biomass_cpue,
                            lengths_maxyr0,
                            biomass, 
                            spp_print, 
                            spp_code,
                            maxyr, 
                            compareyr, 
                            tab_majorspp_bio = "tab_majortaxa_pchange", 
                            total_biomass, 
                            spp_info) {
  
  
  # Data work up
  
  # haul_maxyr0 <- haul0 %>% 
  #   dplyr::filter(SRVY %in% SRVY1 &
  #                   year == maxyr)
  
  
  lengths_maxyr0 <- lengths_maxyr0 %>% 
    dplyr::filter(species_code %in% spp_code & 
                    SRVY %in% SRVY1)
  
  # tables from maxyr
  table_spp_maxyr <- 
    species_table(haul0 = haul0 %>% 
                    dplyr::filter(year == maxyr &
                                    species_code %in% spp_code), 
                  spp_print, 
                  # spp_sci,
                  SURVEY000 = SURVEY000, 
                  SRVY1 = SRVY1) 
  
  # tables from compareyr
  table_spp_compareyr <- 
    species_table(haul0 =  haul0 %>% 
                    dplyr::filter(year == compareyr &
                                    species_code %in% spp_code), 
                  spp_print, 
                  # spp_sci,
                  SURVEY000 = SURVEY000,
                  SRVY1 = SRVY1) 
  
  
  table_spp <- dplyr::full_join(
    x = table_spp_maxyr$print %>% 
      dplyr::rename(
        min_maxyr = Min, 
        max_maxyr = Max, 
        ean_maxyr = Mean), 
    y = table_spp_compareyr$print %>% 
      dplyr::rename(
        min_compareyr = Min, 
        max_compareyr = Max, 
        mean_compareyr = Mean), 
    by = "Metric") %>% 
    flextable::flextable(.) %>%
    theme_flextable_nmfstm()
  
  text_spp <- species_text(
    haul0, 
    biomass_cpue,
    lengths_maxyr0, 
    table_spp_print = table_spp_maxyr$print, 
    # spp_sci,
    spp_print, 
    spp_code, 
    SRVY1, 
    maxyr, 
    compareyr, 
    tab_majorspp_bio, 
    total_biomass, 
    spp_info)
  
  return(list("table_spp" = table_spp, 
              "text_spp" = text_spp))
}



# Save table
res <- knitr::knit_child(
  text = knitr::knit_expand(
    file = paste0(dir_code, "_child_save_figtab.Rmd")), 
  quiet = TRUE
)

}
```


## tab-est-[taxon]-[spp]-[wt or num]

```{r tab-est-[taxon]-[spp]-[wt or num], eval = dataTcommF}
if (spp_table_cpue) {
  
  nickname0 <- paste0("tab-est-", spp_taxon, "-", spp_file, "-") 
  
  temp <- biomass %>% 
    dplyr::filter(year == maxyr &
                    stratum %in% strat0 &
                    species_code %in% spp_code) %>% 
    dplyr::select(SRVY, stratum, cpue_kgkm2_mean, cpue_kgkm2_sd, 
                  biomass_mt, biomass_sd, #lowerb, upperb, 
                  cpue_nokm2_mean, cpue_nokm2_sd, 
                  population_count, population_sd, #lowerp, upperp, 
                  n_haul, n_length) %>% # haulcount, n_haul, numcount, n_length) %>% 
    dplyr::mutate(stratum = as.character(stratum)) %>%
    dplyr::arrange(stratum) %>% 
    dplyr::arrange(SRVY) %>% 
    dplyr::mutate(stratum = ifelse(stratum == 999, "Total", stratum))
  
  # Were lengths taken for this taxon? If not, we wont include the n_length column in the table and optomize for space
  include_n_length <- !(sum(temp$n_length[temp$stratum == "Total"] %in% 0) == 
                          length(temp$n_length[temp$stratum == "Total"]))
  
  if (sum(temp$biomass_mt [temp$stratum == "Total"] != 0) > 0) {
    
    if (sum(temp$biomass_mt [temp$stratum == "Total"] %in% 0)>0) {
      
      temp <- temp %>% 
        dplyr::filter(SRVY == temp$SRVY[temp$stratum == "Total" & 
                                          temp$biomass_mt  != 0])
    }
    
    haul_cruises_maxyr0 <- haul_cruises_maxyr %>% 
      dplyr::filter(SRVY %in% unique(temp$SRVY))
    
    for (i in 1:2) {
      # subobj <- TRUE
      # newobj <- ifelse(i==1, TRUE, FALSE)
      table_raw <- table_print <- data.frame()
      
      if (i == 1) { # CPUE (WT/HA) and BIOMASS
        nickname <- paste0(nickname0, "wt")
        
        table_raw <- temp %>% 
          dplyr::select(SRVY, stratum, 
                        cpue_kgkm2_mean, cpue_kgkm2_sd, 
                        biomass_mt, biomass_sd, #lowerb, upperb, 
                        n_haul, n_length) 
        
        if (!include_n_length) {
          table_raw <- table_raw %>% 
            dplyr::select(-n_length)
        }
        
        if (nrow(table_raw) != 0) { # if none were caught, don't do any of this
          
          cpue_kgkm2_mean0<-find_units(unit = "kg/ha", unt = "kg/ha", dat = table_raw$cpue_kgkm2_mean[table_raw$cpue_kgkm2_mean != 0])    
          cpue_kgkm2_sd0<-find_units(unit = "", unt = "", table_raw$cpue_kgkm2_sd[table_raw$cpue_kgkm2_sd != 0])
          biomass_mt0<-find_units(unit = "t", unt = "t", table_raw$biomass_mt [table_raw$biomass_mt  != 0])
          biomass_sd0<-find_units(unit = "", unt = "", table_raw$biomass_sd[table_raw$biomass_sd != 0])
          
          header <- paste0("Mean weight_kg CPUE",cpue_kgkm2_mean0$unit_word,
                           " with standard deviation",cpue_kgkm2_sd0$unit_word,
                           ", and estimated biomass",biomass_mt0$unit_word,
                           " with standard deviation",biomass_sd0$unit_word, 
                           " and 95% lower (LCL;", gsub("[()]", "", biomass_mt0$unit_word),
                           ") and upper (UCL;", gsub("[()]", "", biomass_mt0$unit_word),
                           ") confidence limits for ")
          
          table_print0 <- table_raw %>% 
            dplyr::mutate(cpue_kgkm2_mean = formatC(x = cpue_kgkm2_mean/cpue_kgkm2_mean0$divby, 
                                                    digits = 2, 
                                                    format = "f", big.mark = ","),
                          cpue_kgkm2_sd = formatC(x = cpue_kgkm2_sd/cpue_kgkm2_sd0$divby, 
                                                  digits = 2, 
                                                  format = "f", big.mark = ","), 
                          biomass_mt = formatC(x = biomass_mt/biomass_mt0$divby, 
                                               digits = ifelse(biomass_mt0$divby>1, 2, 0), 
                                               format = "f", big.mark = ",") , 
                          # upperb = formatC(x = upperb/biomass_mt0$divby, 
                          #                  digits = ifelse(biomass_mt0$divby>1, 2, 0), 
                          #                  format = "f", big.mark = ",") , 
                          # lowerb = formatC(x = lowerb/biomass_mt0$divby, 
                          #                  digits = ifelse(biomass_mt0$divby>1, 2, 0), 
                          #                  format = "f", big.mark = ",") , 
                          biomass_sd = formatC(x = biomass_sd/biomass_sd0$divby, 
                                               digits = ifelse(biomass_sd0$divby>1, 2, 0), 
                                               format = "f", big.mark = ","))
          
          if (length(unique(table_raw$SRVY)) > 1) {
            table_print <- table_print0 %>%
              flextable::as_grouped_data(x = ., groups = c("SRVY"), columns = NULL)  %>%
              flextable::as_flextable(font = font0, x = ., hide_grouplabel = TRUE)
          } else {
            table_print <- table_print0 %>% 
              dplyr::select(-SRVY) %>%
              flextable::flextable(data = .)
          }
          table_print <- table_print %>% 
            flextable::set_header_labels(
              x = ., 
              cpue_kgkm2_mean = paste0("Mean CPUE", ifelse(cpue_kgkm2_mean0$unit_word=="", "", paste0("\n",cpue_kgkm2_mean0$unit_word))), 
              cpue_kgkm2_sd = paste0("SD CPUE", ifelse(cpue_kgkm2_sd0$unit_word=="", "", paste0("\n",cpue_kgkm2_sd0$unit_word))), 
              biomass_mt = paste0("Estimated biomass", ifelse(biomass_mt0$unit_word=="", "", paste0("\n",biomass_mt0$unit_word))), 
              biomass_sd = paste0("SD biomass", ifelse(biomass_sd0$unit_word=="", "", paste0("\n",biomass_sd0$unit_word)))#, 
              # lowerb = paste0("95% LCL", ifelse(biomass_mt0$unit_word=="", "", paste0("\n",biomass_mt0$unit_word))), 
              # upperb = paste0("95% UCL", ifelse(biomass_mt0$unit_word=="", "", paste0("\n",biomass_mt0$unit_word)))
            ) 
        }
      } else { # CPUE No/HA and population_count
        
        nickname <- paste0(nickname0, "num")
        
        table_raw <- temp %>% 
          dplyr::select(SRVY, stratum, 
                        cpue_nokm2_mean, cpue_nokm2_sd, #, lowerp, upperp
                        population_count, population_sd, n_haul, n_length)
        
        if (!include_n_length) {
          table_raw <- table_raw %>% 
            dplyr::select(-n_length)
        }
        
        if (nrow(table_raw) != 0) { # if none were caught, don't do any of this
          
          cpue_nokm2_mean0 <- find_units(unit = "no./ha", unt = "no./ha", dat = table_raw$cpue_nokm2_mean[table_raw$cpue_nokm2_mean != 0])
          cpue_nokm2_sd0 <- find_units(unit = "", unt = "", table_raw$cpue_nokm2_sd[table_raw$cpue_nokm2_sd != 0])
          population_count0 <- find_units(unit = "", unt = "", table_raw$population_count[table_raw$population_count != 0])
          population_sd0 <- find_units(unit = "", unt = "", table_raw$population_sd[table_raw$population_sd != 0])
          
          header <- paste0("Mean Number CPUE", cpue_nokm2_mean0$unit_word,
                           " with standard deviation", cpue_nokm2_sd0$unit_word,
                           ", and estimated population_count", population_count0$unit_word,
                           " with standard deviation", population_sd0$unit_word, 
                           " and 95% lower (LCL;", gsub("[()]", "", population_count0$unit_word),
                           ") and upper (UCL;", gsub("[()]", "", population_count0$unit_word),
                           ") confidence limits for ")
          
          table_print0 <- table_raw %>% 
            dplyr::mutate(cpue_nokm2_mean = formatC(x = cpue_nokm2_mean/cpue_nokm2_mean0$divby, 
                                                    digits = 2, 
                                                    format = "f", big.mark = ","),
                          cpue_nokm2_sd = formatC(x = cpue_nokm2_sd/cpue_nokm2_sd0$divby, 
                                                  digits = 2, 
                                                  format = "f", big.mark = ","), 
                          population_count = formatC(x = population_count/population_count0$divby, 
                                                     digits = ifelse(population_count0$divby>1, 2, 0), 
                                                     format = "f", big.mark = ",") , 
                          # upperp = formatC(x = upperp/population_count0$divby, 
                          #                  digits = ifelse(population_count0$divby>1, 2, 0), 
                          #                  format = "f", big.mark = ",") , 
                          # lowerp = formatC(x = lowerp/population_count0$divby, 
                          #                  digits = ifelse(population_count0$divby>1, 2, 0), 
                          #                  format = "f", big.mark = ",") , 
                          population_sd = formatC(x = population_sd/population_sd0$divby, 
                                                  digits = ifelse(population_sd0$divby>1, 2, 0), 
                                                  format = "f", big.mark = ","))
          
          if (length(unique(table_raw$SRVY)) > 1) {
            table_print <- table_print0 %>%
              flextable::as_grouped_data(x = ., groups = c("SRVY"), columns = NULL)  %>%
              flextable::as_flextable(font = font0, x = ., hide_grouplabel = TRUE)
          } else {
            table_print <- table_print0 %>% 
              dplyr::select(-SRVY) %>%
              flextable::flextable(data = .)
          }
          table_print <- table_print %>% 
            flextable::set_header_labels(
              x = ., 
              cpue_nokm2_mean = paste0("Mean CPUE", ifelse(cpue_nokm2_mean0$unit_word=="", "", paste0("\n", cpue_nokm2_mean0$unit_word))), 
              cpue_nokm2_sd = paste0("SD CPUE", ifelse(cpue_nokm2_sd0$unit_word=="", "", paste0("\n", cpue_nokm2_sd0$unit_word))), 
              population_count = paste0("Estimated Population", 
                                        ifelse(population_count0$unit_word=="", "", paste0("\n", population_count0$unit_word))),
              population_sd = paste0("SD Population", ifelse(population_sd0$unit_word=="", "", paste0("\n", population_sd0$unit_word)))#, 
              # lowerp = paste0("95% LCL", ifelse(population_count0$unit_word=="", "", paste0("\n", population_count0$unit_word))), 
              # upperp = paste0("95% UCL", ifelse(population_count0$unit_word=="", "", paste0("\n", population_count0$unit_word)))
            ) 
        }
        
      }
      
      table_raw <- table_raw %>% 
        dplyr::left_join(x = ., 
                         y = haul_cruises_maxyr %>% 
                           dplyr::select(SRVY, SRVY_long))
      
      header <- paste0(header,
                       spp_print, 
                       ifelse(is.na(spp_sci), "", paste0(" (", spp_sci, ")")), 
                       " by stratum encountered during the ",
                       maxyr," ", 
                       ifelse(length(unique(table_raw$SRVY)) > 1, SURVEY, unique(table_raw$SRVY_long)), 
                       " shelf bottom trawl survey",
                       ifelse(length(unique(table_raw$SRVY)) > 1, "s", ""),". ",
                       
                       ifelse(length(setdiff(SRVY1, unique(table_raw$SRVY)))>0, 
                              paste0("This species was not encountered in the ", 
                                     maxyr, " ",
                                     haul_cruises_maxyr$SRVY_long[haul_cruises_maxyr$SRVY != unique(table_raw$SRVY)],
                                     " shelf trawl survey. "), 
                              ""),
                       ifelse(!include_n_length, "No lengths were collected for this taxon. ", ""))#)
      
      table_print <- table_print %>% 
        flextable::bold(x = ., #j = "stratum", 
                        i = ~ (stratum == "Total") ) %>%
        flextable::valign(valign = "top") %>% 
        flextable::set_header_labels(
          x = ., 
          stratum = "Stratum", 
          n_haul = "Hauls with\nweight"#, 
          # numcount = "Hauls with\ncounts"
        )  %>%
        theme_flextable_nmfstm(row_lines = FALSE, 
                               font = font0, 
                               pad = 0, 
                               pgwidth = full_page_landscape_width)  %>%
        flextable::width(x = ., width = 1, unit = "in") %>%
        flextable::width(x = ., width = .5, unit = "in", j = "stratum") %>%
        flextable::align(x = ., 
                         align = "right", part = "all")
      
      if (include_n_length) { # if lengths were collected, include the column
        table_print <- table_print %>% 
          flextable::set_header_labels(
            x = ., 
            n_length = "Hauls with\nlengths")
      }
      
      if (length(unique(table_raw$SRVY)) > 1) {
        table_print <- table_print %>% 
          flextable::bold(x = ., j = 1, i = ~ !is.na(SRVY) ) %>%
          flextable::padding(x = .,
                             j = 1, i = ~ is.na(SRVY),
                             padding.left = 5) %>%
          flextable::align(x = ., i = ~ !is.na(SRVY),
                           align = "left", part = "body") 
      }
      
      if (sum(table_raw$SRVY %in% "NBS")>0) {
        table_print <- table_print %>% 
          flextable::hline(x = .,i = ~ (stratum == "Total"), part = "body")
      }
      
      if (i == 1) {
        table_print <- table_print %>% 
          flextable::width(x = ., j = "biomass_mt", width = 1.25, unit = "in")
      } else {
        table_print <- table_print %>% 
          flextable::width(x = ., j = "population_count", width = 1.25, unit = "in")
      }
      
      # Save table
      res <- knitr::knit_child(
        text = knitr::knit_expand(
          file = paste0(dir_code, "_child_save_figtab.Rmd")), 
        quiet = TRUE
      )
      
    }
  }
}
```
